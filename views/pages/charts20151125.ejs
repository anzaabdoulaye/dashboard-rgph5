<div id="loader" class="loader-overlay hidden">
  <div class="spinner"></div>
</div>
<style>
/* Overlay sombre */
.loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Cacher l'overlay */
.hidden {
  display: none !important;
}

/* Le spinner */
.spinner {
  width: 55px;
  height: 55px;
  border: 6px solid #ddd;
  border-top-color: #12A537; 
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}

/* Animation */
@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
</style>
<div class="row">
	<div class="col-12">
		<div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
			<h4 class="mb-sm-0">Tableau de bord du RGPH-5</h4>
			<div class="page-title-right">
				<ol class="breadcrumb m-0">
					<li class="breadcrumb-item active">Graphiques</li>
				</ol>

			</div>

		</div>
	</div>
	<div class="col-12">
  <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent p-3 rounded shadow-sm">
    <div class="row g-3 w-100">
      


<div class="row">
  <div class="col-3">
    <label>Région</label>
    <select id="region" class="form-select">
      <option value="">-- Sélectionner --</option>
    </select>
  </div>
  <div class="col-3">
    <label>Département</label>
    <select id="departement" class="form-select" disabled>
      <option value="">-- Sélectionner --</option>
    </select>
  </div>
  <div class="col-3">
    <label>Commune</label>
    <select id="commune" class="form-select" disabled>
      <option value="">-- Sélectionner --</option>
    </select>
  </div>
  <div class="col-3">
    <label>Zone de dénombrement (ZD)</label>
    <select id="zd" class="form-select" disabled>
      <option value="">-- Sélectionner --</option>
    </select>
  </div>
</div>
</div></div>
<div class="row">
	<div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">PYRAMIDE DES AGES</h4>
			</div>
			<div class="card-body">
				<canvas id="chartPyramide" ></canvas>
			</div>
		</div>
	</div>
   <div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">Répartition de la population par sexe</h4>
			</div>
			<div class="card-body">
				<canvas id="genderChart" width="600" height="350">
</canvas>
			</div>
		</div>
	</div>
   
 </div>
<div class="row">
   <div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">POPULATION ATTENTUE</h4>
			</div>
			<div class="card-body">
				<canvas id="genderChart2" class="chartjs-chart" data-colors='["--vz-primary-rgb, 0.2", "--vz-primary", "--vz-success-rgb, 0.2", "--vz-success"]'></canvas>
			</div>
		</div>
	</div>
	<div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">RENDEMENT JOURNALIERS DES AGENTS RECENSEURS</h4>
			</div>
			<div class="card-body">
				<canvas id="genderChart1" class="chartjs-chart" data-colors='["--vz-primary-rgb, 0.2", "--vz-primary", "--vz-success-rgb, 0.2", "--vz-success"]'></canvas>
			</div>
		</div>
	</div>
   
 </div>
 

<script>
let genderChart = null;
let pyramideChart = null;
let debounceTimeout;

function showLoader() {
    document.getElementById("loader").classList.remove("hidden");
}

function hideLoader() {
    document.getElementById("loader").classList.add("hidden");
}

/* === Debounce helper === */
function debounce(fn, delay = 300) {
  clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(fn, delay);
}


/* Fonction globale pour mettre à jour tous les graphiques */
async function updateCharts(filters = {}) {

  showLoader(); // <<< afficher le loader

    const queryString = new URLSearchParams(filters).toString();
    const res = await fetch(`/stats?${queryString}`);
    const stats = await res.json();

    console.log("STATS REÇUES =", stats);

    /* === 1. GRAPHIQUE PAR SEXE === */
    /* === Répartition par sexe === */
    const sexe = {
      hommes: stats.hommes || 0,
      femmes: stats.femmes || 0
    };

    if (genderChart) genderChart.destroy();
    const ctxSexe = document.getElementById("genderChart");

    genderChart = new Chart(ctxSexe, {
        type: "bar",
        data: {
            labels: ["Hommes", "Femmes"],
            datasets: [{
                label: "Population",
                data: [sexe.hommes, sexe.femmes],
                backgroundColor: ["#12A537", "#F28F00"]
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });


    /* === 2. PYRAMIDE DES ÂGES === */

    const order = ["0-4","5-9","10-14","15-19","20-24","25-29",
                   "30-34","35-39","40-44","45-49","50+"];

    const pyramideAges = (stats.pyramideAges || []).sort(
        (a, b) => order.indexOf(a.age) - order.indexOf(b.age)
    );

    const labels = pyramideAges.map(d => d.age);
    const hommes = pyramideAges.map(d => -Math.abs(d.hommes || 0));
    const femmes = pyramideAges.map(d => Math.abs(d.femmes || 0));

    const ctxP = document.getElementById("chartPyramide");

    if (pyramideChart) pyramideChart.destroy();

    pyramideChart = new Chart(ctxP, {
        type: "bar",
        data: {
            labels,
            datasets: [
                {
                    label: "Hommes",
                    data: hommes,
                    backgroundColor: "rgba(18, 165, 55, 0.8)",
                },
                {
                    label: "Femmes",
                    data: femmes,
                    backgroundColor: "rgba(242, 143, 0, 0.8)",
                }
            ]
        },
        options: {
            indexAxis: "y",
            responsive: true,
            stacked: true,
            scales: {
                x: {
                    stacked: true,
                    ticks: {
                        callback: value => Math.abs(value)
                    }
                },
                y: { stacked: true }
            }
        }
    });
    hideLoader(); // <<< cacher le loader

}

/* === Déclencher l’affichage initial === */
document.addEventListener("DOMContentLoaded", () => updateCharts({}));



document.addEventListener('DOMContentLoaded', () => {
  const regionSelect = document.getElementById('region');
  const departementSelect = document.getElementById('departement');
  const communeSelect = document.getElementById('commune');
  const zdSelect = document.getElementById('zd');


  // Fonction pour désactiver ou activer tous les selects
  function setSelectsDisabled(state) {
    if (regionSelect) regionSelect.disabled = state;
    if (departementSelect) departementSelect.disabled = state;
    if (communeSelect) communeSelect.disabled = state;
    if (zdSelect) zdSelect.disabled = state;
  }

  // Fonction pour charger les options dans un select
  async function loadOptions(url, select, valueField, textField) {
    showLoader(); // <<< afficher le loader
    select.innerHTML = '<option value="">Chargement...</option>';
    select.disabled = true;
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
      const data = await response.json();

      select.innerHTML = '<option value="">-- Sélectionner --</option>';
      data.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d[valueField];
        opt.textContent = d[textField];
        select.appendChild(opt);
      });

      select.disabled = data.length === 0;
    } catch (err) {
      console.error('Erreur lors du chargement des options:', err);
      select.innerHTML = '<option value="">Erreur de chargement</option>';
      hideLoader();
      select.disabled = true;
    }
  }

 

  // Événements pour chaque select
  regionSelect.addEventListener('change', async () => {
  await loadOptions(`/api/location/departements?region=${regionSelect.value}`, departementSelect, 'code_departement', 'departement');
  communeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
  zdSelect.innerHTML = '<option value="">-- Sélectionner --</option>';

  debounce(() => updateCharts({
    region: regionSelect.value
  }));
});

departementSelect.addEventListener('change', async () => {
  await loadOptions(`/api/location/communes?departement=${departementSelect.value}`, communeSelect, 'code_commune', 'commune');
  zdSelect.innerHTML = '<option value="">-- Sélectionner --</option>';

  debounce(() => updateCharts({
    region: regionSelect.value,
    departement: departementSelect.value
  }));
});

communeSelect.addEventListener('change', async () => {
  await loadOptions(`/api/location/zds?commune=${communeSelect.value}`, zdSelect, 'mo_zd', 'mo_zd');

  debounce(() => updateCharts({
    region: regionSelect.value,
    departement: departementSelect.value,
    commune: communeSelect.value
  }));
});

zdSelect.addEventListener('change', () =>
  debounce(() => updateCharts({
    region: regionSelect.value,
    departement: departementSelect.value,
    commune: communeSelect.value,
    zd: zdSelect.value
  })
));

  // Initialisation
  loadOptions('/api/location/regions', regionSelect, 'code_region', 'region');
});
</script>
  <!-- Chart JS -->
    <script src="assets/libs/chart.js/chart.umd.js"></script>