<div id="globalLoader" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.7);
  z-index: 9999;
  justify-content: center;
  align-items: center;
">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Chargement...</span>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
            <h4 class="mb-sm-0">Graphiques du RGPH-5</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item active">Visualisation</li>
                </ol>
                <button id="refreshAll" class="btn btn-sm btn-outline-primary ms-3" title="RafraÃ®chir les donnÃ©es">
    <i class="ri-refresh-line"></i> RafraÃ®chir
  </button>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent p-3 rounded shadow-sm">
            <div class="row g-3 w-100">
                <div class="row">
                    <div class="col-3">
                        <label>RÃ©gion</label>
                        <% if (user.canChangeRegion) { %>
                            <select id="region" class="form-select">
                                <option value="">-- SÃ©lectionner --</option>
                                <% selects.regions.forEach(region => { %>
                                    <option value="<%= region.code_region %>"><%= region.region %></option>
                                <% }); %>
                            </select>
                        <% } else { %>
                            <% const defaultRegion = user.defaultRegion || selects.regions[0]?.code_region || ''; %>
                            <% const defaultRegionName = selects.regions[0]?.region || 'RÃ©gion non disponible'; %>
                            <input type="hidden" id="region" value="<%= defaultRegion %>">
                            <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
                                <%= defaultRegionName %>
                            </div>
                        <% } %>
                    </div>

                    <div class="col-3">
                        <label>DÃ©partement</label>
                        <% if (user.canChangeDepartement) { %>
                            <select id="departement" class="form-select">
                                <option value="">-- SÃ©lectionner --</option>
                            </select>
                        <% } else { %>
                            <% const defaultDept = user.defaultDepartement || selects.departements[0]?.code_departement || ''; %>
                            <% const defaultDeptName = selects.departements[0]?.departement || 'DÃ©partement non disponible'; %>
                            <input type="hidden" id="departement" value="<%= defaultDept %>">
                            <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
                                <%= defaultDeptName %>
                            </div>
                        <% } %>
                    </div>

                    <div class="col-3">
                        <label>Commune</label>
                        <% if (user.canChangeCommune) { %>
                            <select id="commune" class="form-select">
                                <option value="">-- SÃ©lectionner --</option>
                            </select>
                        <% } else { %>
                            <% const defaultCommune = user.defaultCommune || selects.communes[0]?.code_commune || ''; %>
                            <% const defaultCommuneName = selects.communes[0]?.commune || 'Commune non disponible'; %>
                            <input type="hidden" id="commune" value="<%= defaultCommune %>">
                            <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
                                <%= defaultCommuneName %>
                            </div>
                        <% } %>
                    </div>

                    <div class="col-3">
                        <label>Zone de dÃ©nombrement (ZD)</label>
                        <select id="zd" class="form-select">
                            <option value="">-- SÃ©lectionner --</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">PYRAMIDE DES Ã‚GES</h4>
            </div>
            <div class="card-body">
                <div style="height: 400px;">
                    <canvas id="chartPyramide"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">RÃ‰PARTITION PAR SEXE</h4>
            </div>
            <div class="card-body">
                <div style="height: 400px; display: flex; justify-content: center;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">PROGRESSION DE LA COLLECTE</h4>
            </div>
            <div class="card-body">
                <div style="height: 350px; display: flex; justify-content: center;">
                    <canvas id="popChartPie"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="assets/libs/chart.js/chart.umd.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
  // SÃ‰CURITÃ‰ : SmartCache
        if (typeof SmartCache !== 'undefined') SmartCache.clear();

        const selects = {
            region: document.getElementById('region'),
            departement: document.getElementById('departement'),
            commune: document.getElementById('commune'),
            zd: document.getElementById('zd')
        };
        
        let charts = { pyramide: null, gender: null, progression: null };
        const isActiveSelect = (element) => element && element.tagName === 'SELECT';

        const getSelectValue = (elementId) => {
            const element = document.getElementById(elementId);
            if (!element) return '';
            return element.value || ''; 
        };

        const optionsCache = {};
        
        // --- 2. INSTANCES CHART.JS ---

        // --- 3. UTILITAIRES ---
        const showLoader = () => {
            const loader = document.getElementById('globalLoader');
            if (loader) loader.style.display = 'flex';
        };

        const hideLoader = () => {
            const loader = document.getElementById('globalLoader');
            if (loader) loader.style.display = 'none';
        };

        function debounce(fn, delay = 200) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        // --- 4. CHARGEMENT DES OPTIONS (Cascading) ---
        async function loadOptions(url, select, valueField, textField) {
            if (!isActiveSelect(select)) return;

            const cacheKey = url;
            if (optionsCache[cacheKey]) {
                populateSelect(select, optionsCache[cacheKey], valueField, textField);
                return;
            }

            const currentValue = select.value;
            select.innerHTML = '<option value="" disabled selected>Chargement...</option>';
            select.disabled = false; 

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                optionsCache[cacheKey] = data;
                populateSelect(select, data, valueField, textField);

                if (currentValue && data.some(item => item[valueField] === currentValue)) {
                    select.value = currentValue;
                }
            } catch (err) {
                console.error('Erreur loadOptions:', err);
                select.innerHTML = '<option value="">Erreur</option>';
            }
        }

        function populateSelect(select, data, valueField, textField) {
            select.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
            if (data && data.length > 0) {
                data.forEach(item => {
                    select.appendChild(new Option(item[textField], item[valueField]));
                });
            }
            select.disabled = false;
        }

        // --- 5. CHARGEMENT DES DONNÃ‰ES STATS (CORRIGÃ‰) ---
        async function fetchStats(paramsObj) {
            const cleanParams = {};
            Object.entries(paramsObj).forEach(([key, value]) => {
                if (value && value.trim() !== '') cleanParams[key] = value;
            });
            
            const queryString = new URLSearchParams(cleanParams).toString();
            // Ajout _t pour Ã©viter le cache navigateur agressif
            const url = `/stats?${queryString}&_t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                const json = await response.json();
                return json;
            } catch (error) {
                console.error("Erreur fetch stats:", error);
                return null;
            }
        }

        async function updateCharts() {
            showLoader();
            try {
                const paramsObj = {
                    region: getSelectValue('region'),
                    departement: getSelectValue('departement'),
                    commune: getSelectValue('commune'),
                    zd: getSelectValue('zd')
                };
                console.log('ðŸ“Š Charts - ParamÃ¨tres:', paramsObj);

                // Appel API
                const url = `/stats?` + new URLSearchParams(Object.fromEntries(Object.entries(paramsObj).filter(([_, v]) => v))).toString();
                const response = await fetch(url);
                const data = await response.json();

                if (data) {
                    // VÃ©rification des clÃ©s pour Pyramide
                    // Supporte les deux formats possibles (pyramideAges ou pyramideData)
                    const pyraData = data.pyramideAges || data.pyramideData || [];
                    console.log("DonnÃ©es Pyramide reÃ§ues:", pyraData.length, "entrÃ©es");
                    
                    updatePyramideChart(pyraData);
                    updateGenderChart(data.populationStats || {});
                    updateProgressionChart(data.mainStats || {});
                }
            } catch (err) {
                console.error('Erreur updateCharts:', err);
            } finally {
                hideLoader();
            }
        }

        const debouncedUpdateCharts = debounce(updateCharts, 300);

        // --- 6. LOGIQUE DES GRAPHIQUES (SÃ‰CURISÃ‰E) ---

        // A. Pyramide des Ã‚ges
        function updatePyramideChart(data) {
            const ctx = document.getElementById("chartPyramide");
            if (!ctx) return;

            // Protection contre undefined/null
            if (!Array.isArray(data) || data.length === 0) {
                console.warn("âš ï¸ DonnÃ©es Pyramide vides ou invalides", data);
                // On vide le graph s'il existe mais on ne plante pas
                if (charts.pyramide) {
                    charts.pyramide.data.datasets.forEach((dataset) => {
                        dataset.data = [];
                    });
                    charts.pyramide.update();
                }
                return;
            }

            // Mapping sÃ©curisÃ©
            const labels = data.map(d => d.age);
            const hommes = data.map(d => -Math.abs(d.hommes || 0)); 
            const femmes = data.map(d => Math.abs(d.femmes || 0));

            if (charts.pyramide) {
                charts.pyramide.data.labels = labels;
                charts.pyramide.data.datasets[0].data = hommes;
                charts.pyramide.data.datasets[1].data = femmes;
                charts.pyramide.update();
            } else {
                charts.pyramide = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Hommes',
                                data: hommes,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            },
                            {
                                label: 'Femmes',
                                data: femmes,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                ticks: {
                                    callback: function(val) { return Math.abs(val); }
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + Math.abs(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // B. RÃ©partition par Sexe
        function updateGenderChart(stats) {
            const ctx = document.getElementById("genderChart");
            if (!ctx) return;
            
            // Protection valeurs par dÃ©faut
            const hommes = stats.hommes || 0;
            const femmes = stats.femmes || 0;

            if (charts.gender) {
                charts.gender.data.datasets[0].data = [hommes, femmes];
                charts.gender.update();
            } else {
                charts.gender = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Hommes', 'Femmes'],
                        datasets: [{
                            data: [hommes, femmes],
                            backgroundColor: ['#36A2EB', '#FF6384']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        }

        // C. Progression Collecte
        function updateProgressionChart(stats) {
            const ctx = document.getElementById("popChartPie");
            if (!ctx) return;

            // Protection valeurs par dÃ©faut
            const collectee = stats.collectee || 0;
            const carto = stats.cartographie || 0;
            const restant = Math.max(0, carto - collectee);
            const pCt = carto > 0 ? ((collectee / carto) * 100).toFixed(1) : 0;

            if (charts.progression) {
                charts.progression.data.labels = [`CollectÃ©e (${pCt}%)`, 'Reste Ã  faire'];
                charts.progression.data.datasets[0].data = [collectee, restant];
                charts.progression.update();
            } else {
                charts.progression = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: [`CollectÃ©e (${pCt}%)`, 'Reste Ã  faire'],
                        datasets: [{
                            data: [collectee, restant],
                            backgroundColor: ['#4BC0C0', '#E7E9ED']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        }

        // --- 7. LISTENERS ---
        if (isActiveSelect(selects.region)) {
            selects.region.addEventListener('change', async () => {
                if (isActiveSelect(selects.departement)) selects.departement.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
                if (isActiveSelect(selects.commune)) selects.commune.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
                if (isActiveSelect(selects.zd)) selects.zd.innerHTML = '<option value="">-- SÃ©lectionner --</option>';

                if (selects.region.value) {
                    await loadOptions(`/api/location/departements?region=${selects.region.value}`, 
                                      selects.departement, 'code_departement', 'departement');
                }
                debouncedUpdateCharts();
            });
        }

        if (isActiveSelect(selects.departement)) {
            selects.departement.addEventListener('change', async () => {
                if (isActiveSelect(selects.commune)) selects.commune.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
                if (isActiveSelect(selects.zd)) selects.zd.innerHTML = '<option value="">-- SÃ©lectionner --</option>';

                if (selects.departement.value) {
                    await loadOptions(`/api/location/communes?departement=${selects.departement.value}`, 
                                      selects.commune, 'code_commune', 'commune');
                }
                debouncedUpdateCharts();
            });
        }

        if (isActiveSelect(selects.commune)) {
            selects.commune.addEventListener('change', async () => {
                if (isActiveSelect(selects.zd)) selects.zd.innerHTML = '<option value="">-- SÃ©lectionner --</option>';

                if (selects.commune.value) {
                    await loadOptions(`/api/location/zds?commune=${selects.commune.value}`, 
                                      selects.zd, 'mo_zd', 'mo_zd');
                }
                debouncedUpdateCharts();
            });
        }

        if (isActiveSelect(selects.zd)) {
            selects.zd.addEventListener('change', () => debouncedUpdateCharts());
        }

        // --- 8. INITIALISATION PAGE ---
        async function initializePage() {
            const userRole = '<%= user.role %>';
            const regionCode = getSelectValue('region');
            const deptCode = getSelectValue('departement');
            const communeCode = getSelectValue('commune');

            console.log('ðŸš€ Init Page. Role:', userRole, 'Codes:', {regionCode, deptCode, communeCode});

            try {
                // Chargement initial pour ROLE_GLOBAL
                if (userRole === 'ROLE_GLOBAL' && isActiveSelect(selects.region)) {
                    if (selects.region.options.length <= 1) {
                         await loadOptions('/api/location/regions', selects.region, 'code_region', 'region');
                    }
                }

                // Chargements en cascade (si les valeurs sont prÃ©-remplies par le contrÃ´leur)
                if (regionCode && isActiveSelect(selects.departement)) {
                     await loadOptions(`/api/location/departements?region=${regionCode}`, 
                                       selects.departement, 'code_departement', 'departement');
                     if (deptCode) selects.departement.value = deptCode;
                }

                if (deptCode && isActiveSelect(selects.commune)) {
                     await loadOptions(`/api/location/communes?departement=${deptCode}`, 
                                       selects.commune, 'code_commune', 'commune');
                     if (communeCode) selects.commune.value = communeCode;
                }

                if (communeCode && isActiveSelect(selects.zd)) {
                     await loadOptions(`/api/location/zds?commune=${communeCode}`, 
                                       selects.zd, 'mo_zd', 'mo_zd');
                }

                // Chargement des graphiques
                await updateCharts();

            } catch (err) {
                console.error("Erreur initialisation:", err);
            }
        }

setTimeout(() => {
            // Charger les options initiales si nÃ©cessaire (ROLE_GLOBAL)
            // Puis updateCharts()
            initializePage();
            updateCharts(); 
        }, 100);
    });
</script>