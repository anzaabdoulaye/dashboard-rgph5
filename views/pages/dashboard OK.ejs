<div id="globalLoader" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.7);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  opacity: 0.5;
">
  <div style="text-align: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <div style="margin-top: 10px; font-weight: bold;">Chargement...</div>
  </div>
</div>


<div class="row">
	<div class="col-12">
		<div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
			<h4 class="mb-sm-0">Tableau de bord du RGPH-5</h4>
			<div class="page-title-right">
				<ol class="breadcrumb m-0">
					<li class="breadcrumb-item active">Indicateurs</li>
				</ol>

			</div>

		</div>
	</div>
	<div class="col-12">
  <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent p-3 rounded shadow-sm">
    <div class="row g-3 w-100">
      


<div class="row">
  <div class="col-3">
    <label>RÃ©gion</label>
    <select id="region" class="form-select">
      <option value="">-- SÃ©lectionner --</option>
    </select>
  </div>
  <div class="col-3">
    <label>DÃ©partement</label>
    <select id="departement" class="form-select" disabled>
      <option value="">-- SÃ©lectionner --</option>
    </select>
  </div>
  <div class="col-3">
    <label>Commune</label>
    <select id="commune" class="form-select" disabled>
      <option value="">-- SÃ©lectionner --</option>
    </select>
  </div>
  <div class="col-3">
    <label>Zone de dÃ©nombrement (ZD)</label>
    <select id="zd" class="form-select" disabled>
      <option value="">-- SÃ©lectionner --</option>
    </select>
  </div>
</div>



    </div>
  </div>
</div>
</div></div>

<div class="row">
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NB MEN ENUMERES
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="menEnumeresSpan" class="counter-value" data-target="197"><%= stats.menagesEnumeres ?? 0 %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>

				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NB MEN DENOMBRES
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="menDenombresSpan" class="counter-value"><%= stats.menagesDenombres ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<!--
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP CARTO
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="popSpan" class="counter-value">stats.totalPopulation ?? 0</span>
								</h2>
							</div>
						</div>
					</div>
				</div> -->
				<!-- end col -->
				
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TOTAL HOMMES
							<i class=" ri-men-fill text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-men-line  display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="totalHommesSpan" class="counter-value" data-target="32.89"><%= stats.hommes?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TOTAL FEMMES
							<i class="ri-women-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-women-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="totalFemmesSpan" class="counter-value" data-target="1596.5"><%= stats.femmes ?? 0 %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP TOTALE
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popTotaleSpan" class="counter-value" data-target="489.4"><%= stats.total ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP RURALE
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popRuraleSpan" class="counter-value" data-target="489.4"><%= stats.populationRurale ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">ECART NMC ET NMD
							<i class="ri-group-fill text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-group-fill display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="enmcdPop" class="counter-value" data-target="32.89"><%= stats.enmcd.ecart ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
</div>
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">	
				
				
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TAUX PROGRESSION
							<i class="ri-percent-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-percent-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span class="counter-value" data-target="2659">0</span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">DUREE MOYENNE INTERVIEW
							<i class="ri-time-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-time-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span class="counter-value" data-target="1596.5">0</span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TAILLE MOYENNE MENAGE
							<i class="ri-percent-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-percent-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span class="counter-value" data-target="2659"></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">RRAVI
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span class="counter-value" data-target="197"> </span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">RAPPORT DE MASCULINITE
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span class="counter-value" data-target="197"> </span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PARITE ATTEINTE 15-49 ANS
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span class="counter-value" data-target="489.4">0</span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
</div>
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">
				
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MOYEN DECES PAR MENAGE
							<i class="ri-team-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-group-fill display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<h2 class="mb-0 cfs-22"><span id="decesSpan" class="counter-value"><%= (stats.averageDeces !== undefined && stats.averageDeces !== null) ? Number(stats.averageDeces).toFixed(2) : 'â€”' %></span>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->


				<!--DÃ©but Ly -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PROPORTION MENAGES AGRICOLES
							<i class="ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" display-6 text-muted cfs-22">ðŸŒ¾</i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="agriSpan" class="counter-value"><%= stats.proportionAgricoles %> %</span>
								</h2> %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NMPE
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span class="counter-value" id="emigreSpan" data-target="197"> <%= stats.averageEmigres %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PROP ENFANTS 0-5 ANS
							<i class=" ri-emotion-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-emotion-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="enfantSpan" class="counter-value" data-target="489.4"> <%= stats.proportionEnfantsMoins5 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MENAGES +10 INDIVIDUS
							<i class="ri-team-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="grandMenagesSpan" class="counter-value" data-target="32.89">  <%= stats.nbMenagesPlus10 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MENAGES 1 INDIVIDUS
							<i class="ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="menagesSoloSpan"  class="counter-value" data-target="1596.5"><%= stats.nbMenagesSolo %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- FIN Ly-->
				
        
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
  
</div>
<!-- end col --></div><!-- end row -->




<script>
document.addEventListener('DOMContentLoaded', () => {
  const selects = {
    region: document.getElementById('region'),
    departement: document.getElementById('departement'),
    commune: document.getElementById('commune'),
    zd: document.getElementById('zd')
  };

  const statsSpans = {
    popSpan: 'totalPopulation',
    menageSpan: 'totalMenages',
    decesSpan: 'averageDeces',
    agriSpan: 'proportionAgricoles',
    emigreSpan: 'averageEmigres',
    enfantSpan: 'proportionEnfantsMoins5',
    grandMenagesSpan: 'nbMenagesPlus10',
    menagesSoloSpan: 'nbMenagesSolo',
    popTotaleSpan: 'total',
    totalHommesSpan: 'hommes',
    totalFemmesSpan: 'femmes',
    enmcdPop: 'enmcd.ecart',
    menEnumeresSpan: 'menagesEnumeres',
    menDenombresSpan: 'menagesDenombres',
    popRuraleSpan: 'populationRurale'
  };

  const globalLoader = document.getElementById('globalLoader');
  const showLoader = () => globalLoader && (globalLoader.style.display = 'flex');
  const hideLoader = () => globalLoader && (globalLoader.style.display = 'none');

  const debounce = (fn, delay = 200) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  };

  // Fonction pour mettre Ã  jour les stats
  const updateStats = async () => {
    showLoader();
    try {
      const params = new URLSearchParams({
        region: selects.region.value,
        departement: selects.departement.value,
        commune: selects.commune.value,
        zd: selects.zd.value
      });

      const res = await fetch(`/stats?${params}`);
      if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
      const data = await res.json();

      Object.entries(statsSpans).forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (!el) return;
        const value = key.includes('.') ? key.split('.').reduce((o,k)=>o?.[k], data) : data[key];
        el.textContent = (key === 'averageDeces' && value !== undefined && value !== null)
                          ? Number(value).toFixed(2)
                          : (key === 'proportionAgricoles' && value !== undefined ? `${value} %` : value ?? 'â€”');
      });
    } catch(err) {
      console.error('Erreur stats:', err);
      Object.keys(statsSpans).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = 'â€”';
      });
    } finally {
      hideLoader();
    }
  };

  const debouncedUpdateStats = debounce(updateStats, 200);

  // Fonction pour charger les options d'un select
  const loadOptions = async (url, select, valueField, textField) => {
    select.innerHTML = '<option value="">Chargement...</option>';
    select.disabled = true;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
      const data = await res.json();

      const fragment = document.createDocumentFragment();
      const defaultOpt = document.createElement('option');
      defaultOpt.value = '';
      defaultOpt.textContent = '-- SÃ©lectionner --';
      fragment.appendChild(defaultOpt);

      data.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d[valueField];
        opt.textContent = d[textField];
        fragment.appendChild(opt);
      });

      select.innerHTML = '';
      select.appendChild(fragment);
      select.disabled = data.length === 0;
    } catch(err) {
      console.error('Erreur chargement options:', err);
      select.innerHTML = '<option value="">Erreur</option>';
      select.disabled = true;
    }
  };

  // Ã‰vÃ©nements sur les selects
  selects.region.addEventListener('change', async () => {
    selects.departement.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
    selects.departement.disabled = true;
    selects.commune.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
    selects.commune.disabled = true;
    selects.zd.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
    selects.zd.disabled = true;

    if (selects.region.value) {
      await loadOptions(`/api/location/departements?region=${selects.region.value}`, selects.departement, 'code_departement', 'departement');
    }
    debouncedUpdateStats();
  });

  selects.departement.addEventListener('change', async () => {
    selects.commune.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
    selects.commune.disabled = true;
    selects.zd.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
    selects.zd.disabled = true;

    if (selects.departement.value) {
      await loadOptions(`/api/location/communes?departement=${selects.departement.value}`, selects.commune, 'code_commune', 'commune');
    }
    debouncedUpdateStats();
  });

  selects.commune.addEventListener('change', async () => {
    selects.zd.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
    selects.zd.disabled = true;

    if (selects.commune.value) {
      await loadOptions(`/api/location/zds?commune=${selects.commune.value}`, selects.zd, 'mo_zd', 'mo_zd');
    }
    debouncedUpdateStats();
  });

  selects.zd.addEventListener('change', debouncedUpdateStats);

  // Chargement initial
  loadOptions('/api/location/regions', selects.region, 'code_region', 'region');
});
</script>

















