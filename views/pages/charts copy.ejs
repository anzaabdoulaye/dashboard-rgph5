<style>
/* Spinner simple pour les selects et stats */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(0,0,0,0.2);
  border-top-color: rgba(0,0,0,0.8);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
  margin-left: 5px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<div class="row">
	<div class="col-12">
		<div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
			<h4 class="mb-sm-0">Tableau de bord du RGPH-5</h4>
			<div class="page-title-right">
				<ol class="breadcrumb m-0">
					<li class="breadcrumb-item active">Graphiques</li>
				</ol>

			</div>

		</div>
	</div>
	<div class="col-12">
  <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent p-3 rounded shadow-sm">
    <div class="row g-3 w-100">
      


<div class="row">
  <div class="col-3">
    <label>Région</label>
    <select id="region" class="form-select">
      <option value="">-- Sélectionner --</option>
      <% selects.regions.forEach(r => { %>
        <option value="<%= r.code_region %>" <%= filters.region == r.code_region ? 'selected' : '' %>><%= r.region %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-3">
    <label>Département</label>
    <select id="departement" class="form-select">
      <option value="">-- Sélectionner --</option>
      <% selects.departements.forEach(d => { %>
        <option value="<%= d.code_departement %>" <%= filters.departement == d.code_departement ? 'selected' : '' %>><%= d.departement %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-3">
    <label>Commune</label>
    <select id="commune" class="form-select">
      <option value="">-- Sélectionner --</option>
      <% selects.communes.forEach(c => { %>
        <option value="<%= c.code_commune %>" <%= filters.commune == c.code_commune ? 'selected' : '' %>><%= c.commune %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-3">
    <label>Zone de dénombrement (ZD)</label>
    <select id="zd" class="form-select">
      <option value="">-- Sélectionner --</option>
      <% selects.zds.forEach(z => { %>
        <option value="<%= z.mo_zd %>" <%= filters.zd == z.mo_zd ? 'selected' : '' %>><%= z.mo_zd %></option>
      <% }) %>
    </select>
  </div>
</div>
</div></div>
<div class="row">
	<div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">PYRAMIDE DES AGES</h4>
			</div>
			<div class="card-body">
				<canvas id="chartPyramide" ></canvas>
			</div>
		</div>
	</div>
   <div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">Répartition de la population par sexe</h4>
			</div>
			<div class="card-body">
				<canvas id="genderChart" width="600" height="350">
</canvas>
			</div>
		</div>
	</div>
   
 </div>
<div class="row">
   <div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">POPULATION ATTENTUE</h4>
			</div>
			<div class="card-body">
				<canvas id="genderChart2" class="chartjs-chart" data-colors='["--vz-primary-rgb, 0.2", "--vz-primary", "--vz-success-rgb, 0.2", "--vz-success"]'></canvas>
			</div>
		</div>
	</div>
	<div class="col-xl-6">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-0">RENDEMENT JOURNALIERS DES AGENTS RECENSEURS</h4>
			</div>
			<div class="card-body">
				<canvas id="genderChart1" class="chartjs-chart" data-colors='["--vz-primary-rgb, 0.2", "--vz-primary", "--vz-success-rgb, 0.2", "--vz-success"]'></canvas>
			</div>
		</div>
	</div>
   
 </div>
 

  <!-- Chart JS -->
    <script src="assets/libs/chart.js/chart.umd.js"></script>
<script>
  fetch("/stats")
  .then(res => res.json())
  .then(stats => {
      const { hommes, femmes } = stats.populationSexe;

      new Chart(document.getElementById('genderChart'), {
        type: 'bar',
        data: {
          labels: ['Hommes', 'Femmes'],
          datasets: [{
            label: 'Population',
            data: [hommes, femmes],
            backgroundColor: ['#12A537', '#F28F00']
          }]
        }
      });
  });
</script>
<script>
fetch("/stats")
  .then(res => res.json())
  .then(stats => {

    // 1. Trier les tranches d’âges
    const pyramideAges = stats.pyramideAges.sort((a, b) => {
      const order = [
        "0-4", "5-9", "10-14", "15-19", "20-24",
        "25-29", "30-34", "35-39", "40-44", "45-49", "50+"
      ];
      return order.indexOf(a.age) - order.indexOf(b.age);
    });

    // 2. Préparer labels et données
    const labels = pyramideAges.map(d => d.age);
    const hommes = pyramideAges.map(d => -Math.abs(d.hommes));
    const femmes = pyramideAges.map(d => Math.abs(d.femmes));

    const ctx = document.getElementById("chartPyramide");

    new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Hommes",
            data: hommes,
            backgroundColor: "rgba(18, 165, 55, 0.8)",
            borderColor: "rgba(18, 165, 55, 1)",
            borderWidth: 1,
          },
          {
            label: "Femmes",
            data: femmes,
            backgroundColor: "rgba(242, 143, 0, 0.8)",
            borderColor: "rgba(242, 143, 0, 1)",
            borderWidth: 1,
          }
        ]
      },
      options: {
        indexAxis: 'y',

        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + Math.abs(context.raw).toLocaleString();
              }
            }
          }
        },

        scales: {
          x: {
            stacked: true,
            grid: {
              color: "#CCC"
            },
            ticks: {
              callback: value => Math.abs(value).toLocaleString()
            }
          },
          y: {
            stacked: true,
            grid: {
              drawBorder: false,
              color: "#EEE"
            }
          }
        }
      }
    });
  });
</script>


</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const regionSelect = document.getElementById('region');
  const departementSelect = document.getElementById('departement');
  const communeSelect = document.getElementById('commune');
  const zdSelect = document.getElementById('zd');


  // Fonction pour désactiver ou activer tous les selects
  function setSelectsDisabled(state) {
    if (regionSelect) regionSelect.disabled = state;
    if (departementSelect) departementSelect.disabled = state;
    if (communeSelect) communeSelect.disabled = state;
    if (zdSelect) zdSelect.disabled = state;
  }

  // Fonction pour charger les options dans un select
  async function loadOptions(url, select, valueField, textField) {
    select.innerHTML = '<option value="">Chargement...</option>';
    select.disabled = true;
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
      const data = await response.json();

      select.innerHTML = '<option value="">-- Sélectionner --</option>';
      data.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d[valueField];
        opt.textContent = d[textField];
        select.appendChild(opt);
      });

      select.disabled = data.length === 0;
    } catch (err) {
      console.error('Erreur lors du chargement des options:', err);
      select.innerHTML = '<option value="">Erreur de chargement</option>';
      select.disabled = true;
    }
  }

 

  // Événements pour chaque select
  regionSelect.addEventListener('change', async () => {
    await loadOptions(`/api/location/departements?region=${regionSelect.value}`, departementSelect, 'code_departement', 'departement');
    communeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    communeSelect.disabled = true;
    zdSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    zdSelect.disabled = true;
    updateStats();
  });

  departementSelect.addEventListener('change', async () => {
    await loadOptions(`/api/location/communes?departement=${departementSelect.value}`, communeSelect, 'code_commune', 'commune');
    zdSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    zdSelect.disabled = true;
    updateStats();
  });

  communeSelect.addEventListener('change', async () => {
    await loadOptions(`/api/location/zds?commune=${communeSelect.value}`, zdSelect, 'mo_zd', 'mo_zd');
    updateStats();
  });

  zdSelect.addEventListener('change', updateStats);

  // Initialisation
  loadOptions('/api/location/regions', regionSelect, 'code_region', 'region');
});
</script>