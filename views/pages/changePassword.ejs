<!doctype html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable" data-theme="default" data-theme-colors="default">

<head>
    <meta charset="utf-8" />
    <title>Changer le mot de passe | Dashboard RGPH5</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
    <meta content="Themesbrand" name="author" />
    <!-- App favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico">

    <!-- Layout config Js -->
    <script src="/assets/js/layout.js"></script>
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/assets/css/icons.min.css" rel="stylesheet" />
    <link href="/assets/css/app.min.css" rel="stylesheet" />
    <link href="/assets/css/custom.min.css" rel="stylesheet" />
    
    <!-- CSS pour les indicateurs de force du mot de passe -->
    <style>
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        .strength-weak { 
            background-color: #dc3545; 
            width: 25%; 
        }
        .strength-fair { 
            background-color: #ffc107; 
            width: 50%; 
        }
        .strength-good { 
            background-color: #28a745; 
            width: 75%; 
        }
        .strength-strong { 
            background-color: #20c997; 
            width: 100%; 
        }
        
        /* Style pour les checkboxes de validation */
        #lengthCheck, #lowerCheck, #upperCheck, #numberCheck, #specialCheck {
            list-style-type: none;
            padding-left: 1.5rem;
            position: relative;
        }
        #lengthCheck:before, #lowerCheck:before, #upperCheck:before, #numberCheck:before, #specialCheck:before {
            content: "○";
            position: absolute;
            left: 0;
        }
        #lengthCheck.text-success:before, 
        #lowerCheck.text-success:before, 
        #upperCheck.text-success:before, 
        #numberCheck.text-success:before, 
        #specialCheck.text-success:before {
            content: "✓";
            color: #28a745;
            font-weight: bold;
        }
        
        /* Style pour le bouton toggle password */
        .password-addon {
            padding: 0.75rem 0.75rem;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .password-addon:hover {
            opacity: 0.8;
        }
    </style>
    
</head>

<body>

    <div class="auth-page-wrapper pt-5">
        <!-- auth page bg -->
        <div class="auth-one-bg-position auth-one-bg" id="auth-particles">
            <div class="bg-overlay"></div>

            <div class="shape">
                <svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1440 120">
                    <path d="M 0,36 C 144,53.6 432,123.2 720,124 C 1008,124.8 1296,56.8 1440,40L1440 140L0 140z"></path>
                </svg>
            </div>
        </div>

        <!-- auth page content -->
        <div class="auth-page-content">
            <div class="container">
                <!-- Messages d'alerte -->
                <% if (success) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ri-check-line me-2"></i>
                    <%= success %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% } %>

                <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ri-error-warning-line me-2"></i>
                    <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% } %>

                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6 col-xl-5">
                        <div class="card mt-4 card-bg-fill">
                            <div class="card-body p-4">
                                <div class="text-center mt-2">
                                    <h5 class="text-primary">Changer votre mot de passe</h5>
                                    <p class="text-muted">C'est votre première connexion. Vous devez choisir un nouveau mot de passe sécurisé.</p>
                                </div>

                                <div class="p-3">
                                    <form id="changePasswordForm" action="/auth/change-password" method="POST">
                                        <!-- Ancien mot de passe (caché ou rappel) -->
                                        <div class="alert alert-info">
                                            <i class="ri-information-line me-2"></i>
                                            Vous êtes connecté avec le mot de passe par défaut. Veuillez en choisir un nouveau.
                                        </div>

                                        <!-- Nouveau mot de passe -->
                                        <div class="mb-3">
                                            <label class="form-label" for="newPassword">
                                                Nouveau mot de passe <span class="text-danger">*</span>
                                            </label>
                                            <div class="position-relative auth-pass-inputgroup">
                                                <input type="password" 
                                                       name="newPassword" 
                                                       class="form-control pe-5" 
                                                       id="newPassword"
                                                       placeholder="Entrez votre nouveau mot de passe"
                                                       required
                                                       minlength="8"
                                                       autocomplete="new-password">
                                                <button class="btn btn-link position-absolute end-0 top-0 text-decoration-none text-muted password-addon"
                                                        type="button"
                                                        id="toggleNewPassword">
                                                    <i class="ri-eye-fill align-middle"></i>
                                                </button>
                                            </div>
                                            <!-- Barre de force du mot de passe -->
                                            <div class="password-strength mt-2" id="passwordStrength"></div>
                                            
                                            <!-- Liste des critères -->
                                            <div class="form-text mt-2">
                                                <ul class="mb-0 ps-0">
                                                    <li id="lengthCheck" class="text-muted">Minimum 8 caractères</li>
                                                    <li id="lowerCheck" class="text-muted">Au moins une minuscule (a-z)</li>
                                                    <li id="upperCheck" class="text-muted">Au moins une majuscule (A-Z)</li>
                                                    <li id="numberCheck" class="text-muted">Au moins un chiffre (0-9)</li>
                                                    <li id="specialCheck" class="text-muted">Au moins un caractère spécial (!@#$%^&*)</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <!-- Confirmation -->
                                        <div class="mb-3">
                                            <label class="form-label" for="confirmPassword">
                                                Confirmer le mot de passe <span class="text-danger">*</span>
                                            </label>
                                            <div class="position-relative auth-pass-inputgroup">
                                                <input type="password" 
                                                       name="confirmPassword" 
                                                       class="form-control pe-5" 
                                                       id="confirmPassword"
                                                       placeholder="Confirmez votre nouveau mot de passe"
                                                       required
                                                       autocomplete="new-password">
                                                <button class="btn btn-link position-absolute end-0 top-0 text-decoration-none text-muted password-addon"
                                                        type="button"
                                                        id="toggleConfirmPassword">
                                                    <i class="ri-eye-fill align-middle"></i>
                                                </button>
                                            </div>
                                            <!-- Message de correspondance -->
                                            <div class="form-text mt-1" id="passwordMatch"></div>
                                        </div>

                                        <!-- Boutons -->
                                        <div class="mt-4">
                                            <button class="btn btn-success w-100" type="submit" id="submitBtn" disabled>
                                                <i class="ri-key-fill me-1"></i> Changer le mot de passe
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lien retour connexion (au cas où) -->
                        <div class="mt-4 text-center">
                            <p class="mb-0">
                                <a href="/auth/logout" class="fw-semibold text-primary text-decoration-underline">
                                    <i class="ri-logout-box-line me-1"></i> Se déconnecter
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end container -->
        </div>
        <!-- end auth page content -->

        <!-- footer -->
        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="text-center">
                            <p class="mb-0 text-muted">&copy; BCR@INS@2025</p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->
    </div>
    <!-- end auth-page-wrapper -->

    <!-- JAVASCRIPT -->
    <script src="/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/libs/simplebar/simplebar.min.js"></script>
    <script src="/assets/libs/node-waves/waves.min.js"></script>
    <script src="/assets/libs/feather-icons/feather.min.js"></script>
    <script src="/assets/js/pages/plugins/lord-icon-2.1.0.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/app.js"></script>

    <script>
        // Variables de validation
        let isPasswordValid = false;
        let isPasswordMatch = false;

        // Toggle visibilité mot de passe
        document.getElementById('toggleNewPassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('newPassword');
            const icon = this.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('ri-eye-fill');
                icon.classList.add('ri-eye-off-fill');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('ri-eye-off-fill');
                icon.classList.add('ri-eye-fill');
            }
        });

        document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('confirmPassword');
            const icon = this.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('ri-eye-fill');
                icon.classList.add('ri-eye-off-fill');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('ri-eye-off-fill');
                icon.classList.add('ri-eye-fill');
            }
        });

        // Validation en temps réel du mot de passe
        document.getElementById('newPassword').addEventListener('input', function() {
            const password = this.value;
            validatePassword(password);
            checkPasswordsMatch();
            updateSubmitButton();
        });

        document.getElementById('confirmPassword').addEventListener('input', function() {
            checkPasswordsMatch();
            updateSubmitButton();
        });

        // Fonction de validation du mot de passe
        function validatePassword(password) {
            const checks = {
                length: password.length >= 8,
                lower: /[a-z]/.test(password),
                upper: /[A-Z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*]/.test(password)
            };

            // Mettre à jour l'interface
            updateCheck('lengthCheck', checks.length);
            updateCheck('lowerCheck', checks.lower);
            updateCheck('upperCheck', checks.upper);
            updateCheck('numberCheck', checks.number);
            updateCheck('specialCheck', checks.special);

            // Force du mot de passe
            const strengthBar = document.getElementById('passwordStrength');
            let strength = 0;
            let className = '';
            
            Object.values(checks).forEach(check => {
                if (check) strength++;
            });
            
            if (strength <= 1) {
                className = '';
                strengthBar.style.width = '0%';
            } else if (strength === 2) {
                className = 'strength-weak';
            } else if (strength === 3) {
                className = 'strength-fair';
            } else if (strength === 4) {
                className = 'strength-good';
            } else {
                className = 'strength-strong';
            }
            
            strengthBar.className = `password-strength ${className}`;
            
            // Validation globale
            isPasswordValid = Object.values(checks).every(check => check);
        }

        function updateCheck(elementId, isValid) {
            const element = document.getElementById(elementId);
            if (isValid) {
                element.classList.remove('text-muted');
                element.classList.add('text-success');
                element.innerHTML = `<i class="ri-check-line me-1"></i>${element.textContent.replace('✓ ', '').replace('○ ', '')}`;
            } else {
                element.classList.remove('text-success');
                element.classList.add('text-muted');
                // Garder le texte original sans l'icône
                const text = element.textContent.replace('✓ ', '').replace('○ ', '');
                element.innerHTML = text;
            }
        }

        // Vérification correspondance des mots de passe
        function checkPasswordsMatch() {
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');
            
            if (confirm.length === 0) {
                matchElement.textContent = '';
                matchElement.className = 'form-text';
                isPasswordMatch = false;
                return;
            }
            
            if (password === confirm) {
                matchElement.innerHTML = '<i class="ri-check-line text-success me-1"></i> Les mots de passe correspondent';
                matchElement.className = 'form-text text-success';
                isPasswordMatch = true;
            } else {
                matchElement.innerHTML = '<i class="ri-close-line text-danger me-1"></i> Les mots de passe ne correspondent pas';
                matchElement.className = 'form-text text-danger';
                isPasswordMatch = false;
            }
        }

        // Activation/désactivation du bouton
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            if (isPasswordValid && isPasswordMatch) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-secondary');
                submitBtn.classList.add('btn-success');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-secondary');
            }
        }

        // Validation avant soumission
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            if (!isPasswordValid || !isPasswordMatch) {
                e.preventDefault();
                // Message d'erreur plus élégant
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                errorDiv.innerHTML = `
                    <i class="ri-error-warning-line me-2"></i>
                    Veuillez corriger les erreurs avant de soumettre le formulaire.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insérer au début du formulaire
                const form = document.getElementById('changePasswordForm');
                const firstChild = form.firstChild;
                form.insertBefore(errorDiv, firstChild);
                
                // Scroll vers le haut
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            validatePassword('');
            checkPasswordsMatch();
            updateSubmitButton();
            
            // Focus sur le premier champ
            document.getElementById('newPassword').focus();
        });
    </script>
</body>
</html>