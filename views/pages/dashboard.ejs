<div id="globalLoader" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.7);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  opacity: 0.5;
">
  <div style="text-align: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <div style="margin-top: 10px; font-weight: bold;">Chargement...</div>
  </div>
</div>


<div class="row">
<div class="col-12">
	<div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
		<h4 class="mb-sm-0">Tableau de bord du RGPH-5</h4>
		<div class="page-title-right">
			<ol class="breadcrumb m-0">
				<li class="breadcrumb-item active">Indicateurs</li>
			</ol>
		</div>

	</div>
</div>
<div class="col-12">
  <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent p-3 rounded shadow-sm">
    <div class="row g-3 w-100">
      
<div class="row">
  <!-- R√©gion -->
      <div class="col-3">
        <label>R√©gion</label>
        <% if (user.canChangeRegion) { %>
          <!-- ROLE_GLOBAL : Select actif avec options pr√©charg√©es -->
          <select id="region" class="form-select">
            <option value="">NATIONAL</option>
            <% selects.regions.forEach(region => { %>
              <option value="<%= region.code_region %>"><%= region.region %></option>
            <% }); %>
          </select>
        <% } else { %>
          <!-- R√¥les REGIONAL, DEPARTEMENTAL, COMMUNAL : R√©gion fix√©e -->
          <% const defaultRegion = user.defaultRegion || selects.regions[0]?.code_region || ''; %>
          <% const defaultRegionName = selects.regions[0]?.region || 'R√©gion non disponible'; %>
          
          <input type="hidden" id="region" value="<%= defaultRegion %>">
          <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
            <%= defaultRegionName %>
          </div>
        <% } %>
      </div>
  
        <!-- D√©partement -->
      <div class="col-3">
        <label>D√©partement</label>
        <% if (user.canChangeDepartement) { %>
          <select id="departement" class="form-select">
            <option value="">-- S√©lectionner --</option>
          </select>
        <% } else { %>
          <% const defaultDept = user.defaultDepartement || selects.departements[0]?.code_departement || ''; %>
          <% const defaultDeptName = selects.departements[0]?.departement || 'D√©partement non disponible'; %>
          
          <input type="hidden" id="departement" value="<%= defaultDept %>">
          <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
            <%= defaultDeptName %>
          </div>
        <% } %>
      </div>
  
      <!-- Commune -->
      <div class="col-3">
        <label>Commune</label>
        <% if (user.canChangeCommune) { %>
          <!-- ROLE_GLOBAL, REGIONAL, DEPARTEMENTAL : Select actif -->
          <select id="commune" class="form-select">
            <option value="">-- S√©lectionner --</option>
          </select>
        <% } else { %>
          <!-- ROLE_COMMUNAL : Commune fix√©e -->
          <% const defaultCommune = user.defaultCommune || selects.communes[0]?.code_commune || ''; %>
          <% const defaultCommuneName = selects.communes[0]?.commune || 'Commune non disponible'; %>
          
          <input type="hidden" id="commune" value="<%= defaultCommune %>">
          <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
            <%= defaultCommuneName %>
          </div>
        <% } %>
    </div>
  
    <!-- ZD -->
    <div class="col-3">
      <label>Zone de d√©nombrement (ZD)</label>
      <!-- TOUS les r√¥les peuvent changer de ZD -->
      <select id="zd" class="form-select">
        <option value="">-- S√©lectionner --</option>
      </select>
    </div>
</div>

    </div>
  </div>
</div>
<div class="row">
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">
				<div class="col"  >
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NB MEN ENUMERES
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="menEnumeresSpan" class="counter-value" data-target="197"><%= stats.menagesEnumeres ?? 0 %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>

				<div class="col"  >
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NB MEN DENOMBRES
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="menDenombresSpan" class="counter-value"><%= stats.menagesDenombres ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>	
				<div class="col" >
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TOTAL HOMMES
							<i class=" ri-men-fill text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-men-line  display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="totalHommesSpan" class="counter-value" data-target="32.89"><%= stats.hommes?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  >
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TOTAL FEMMES
							<i class="ri-women-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-women-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="totalFemmesSpan" class="counter-value" data-target="1596.5"><%= stats.femmes ?? 0 %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  >
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP TOTALE
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popTotaleSpan" class="counter-value" data-target="489.4"><%= stats.total ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  >
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP CARTO
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popCartoSpan" class="counter-value" data-target="489.4"><%= stats.cartographie %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<div class="col"  >
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP RURALE
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popRuraleSpan" class="counter-value" data-target="489.4"><%= stats.populationRurale ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				
				<!-- end col -->
				
				
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
</div>
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">	
				
				
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TAUX PROGRESSION
							<i class="ri-percent-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-percent-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id= "tauxProgressionSpan" class="counter-value" data-target="2659"><%= stats.tauxProgressionCollecte %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col 
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">DUREE MOYENNE INTERVIEW
							<i class="ri-time-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-time-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span class="counter-value" data-target="1596.5"></span>
								</h2>
							</div>
						</div>
					</div>
				</div>-->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">ECART NMC ET NMD
							<i class="ri-group-fill text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-group-fill display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="enmcdPop" class="counter-value" data-target="32.89"><%= stats.enmcd.ecart ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TAILLE MOYENNE MENAGE
							<i class="ri-percent-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-percent-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="tmoyenMenSpan" class="counter-value" data-target="2659"><%= stats.tailleMoyenneMenage %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">RRAVI
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="rraviSpan" class="counter-value" data-target="197"><%= stats.RRAVI %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">RAPPORT DE MASCULINITE
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="rMasculiniteSpan" class="counter-value" data-target="197"><%= stats.rapportMasculinite %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PARITE ATTEINTE 15-49 ANS
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="pa49Span" class="counter-value" data-target="489.4"><%= stats.PA49 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
</div>
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">
				
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MOYEN DECES PAR MENAGE
							<i class="ri-team-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-group-fill display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<h2 class="mb-0 cfs-22"><span id="decesSpan" class="counter-value"><%= (stats.averageDeces !== undefined && stats.averageDeces !== null) ? Number(stats.averageDeces).toFixed(2) : '‚Äî' %></span>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->


				<!--D√©but Ly -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PROPORTION MENAGES AGRICOLES
							<i class="ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" display-6 text-muted cfs-22">üåæ</i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="agriSpan" class="counter-value"><%= stats.proportionAgricoles %> %</span>
								</h2> %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NMPE
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span class="counter-value" id="emigreSpan" data-target="197"> <%= stats.averageEmigres %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PROP ENFANTS 0-5 ANS
							<i class=" ri-emotion-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-emotion-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="enfantSpan" class="counter-value" data-target="489.4"> <%= stats.proportionEnfantsMoins5 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MENAGES +10 INDIVIDUS
							<i class="ri-team-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="grandMenagesSpan" class="counter-value" data-target="32.89">  <%= stats.nbMenagesPlus10 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MENAGES 1 INDIVIDUS
							<i class="ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="menagesSoloSpan"  class="counter-value" data-target="1596.5"><%= stats.nbMenagesSolo %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- FIN Ly-->
				
        
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
  
</div>
<div class="row mt-4">
    <div class="col-xl-6">
        <div class="card">
            <div class="card-body">
                <!-- La carte sera ins√©r√©e ici -->
                <div id="map-regions"></div>
            </div>
        </div>
    </div>

    <div class="col-xl-6">
        <div class="card">
            <div class="card-body">
                <!-- La carte sera ins√©r√©e ici -->
                <div id="map-departements"></div>
            </div>
        </div>
    </div>
</div>

<style>
    .map-container {
        height: 400px;
        width: 100%;
        border-radius: 6px;
        z-index: 1;
    }
    
    .map-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
</style>

<!-- end col --></div><!-- end row -->

<script>

document.addEventListener('DOMContentLoaded', () => {
  const selects = {
    region: document.getElementById('region'),
    departement: document.getElementById('departement'),
    commune: document.getElementById('commune'),
    zd: document.getElementById('zd'),
    refreshBtn: document.getElementById('refreshAll')
  };
  
  console.log('üìå Dashboard Initialis√©. √âl√©ments:', selects);

  // ‚úÖ V√©rifie si c'est un select actif
  const isActiveSelect = (element) => {
    return element && element.tagName === 'SELECT';
  };

  // ‚úÖ Gestion am√©lior√©e de la r√©cup√©ration de valeur
  const getSelectValue = (elementId) => {
    const element = document.getElementById(elementId);
    if (!element) return '';
    
    if (element.tagName === 'INPUT' && element.type === 'hidden') {
      return element.value || '';
    }
    
    if (element.tagName === 'SELECT') {
      return element.value || '';
    }
    
    return '';
  };
  
  const statsSpans = {
    menEnumeresSpan: 'mainStats.menagesEnumeres',
    menDenombresSpan: 'mainStats.menagesDenombres',
	  decesSpan: 'mainStats.averageDeces',
	  popCartoSpan: 'mainStats.cartographie',
    tauxProgressionSpan: 'mainStats.tauxProgressionCollecte',
	  tmoyenMenSpan: 'mainStats.tailleMoyenneMenage',
	  enmcdPop: 'mainStats.enmcd.ecart',
	  grandMenagesSpan: 'mainStats.nbMenagesPlus10',
    menagesSoloSpan: 'mainStats.nbMenagesSolo',
    popRuraleSpan: 'mainStats.populationRurale',

    popTotaleSpan: 'populationStats.total',
    totalHommesSpan: 'populationStats.hommes',
    totalFemmesSpan: 'populationStats.femmes',
    enfantSpan: 'populationStats.proportionEnfantsMoins5',
    rraviSpan: 'populationStats.RRAVI',
    rMasculiniteSpan: 'populationStats.rapportMasculinite',
    pa49Span: 'populationStats.PA49',

    emigreSpan: 'averageEmigres',
    agriSpan: 'proportionAgricoles',
  };

  const optionsCache = {};
  const statsCache = {};

  const showLoader = () => {
    const loader = document.getElementById('globalLoader');
    if (loader) loader.style.display = 'flex';
  };
  
  const hideLoader = () => {
    const loader = document.getElementById('globalLoader');
    if (loader) loader.style.display = 'none';
  };

  function debounce(fn, delay = 200) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  }

  async function loadOptions(url, select, valueField, textField) {
    if (!isActiveSelect(select)) {
      console.log(`‚ùå Select ${select.id} n'est pas actif, skip`);
      return;
    }

    const cacheKey = url;
    if (optionsCache[cacheKey]) {
      console.log(`‚úÖ Utilisation du cache pour ${url}`);
      populateSelect(select, optionsCache[cacheKey], valueField, textField);
      return;
    }

    console.log(`üì• Chargement: ${url}`);
    
    // Sauvegarder l'√©tat actuel
    const currentValue = select.value;
    const currentOptions = Array.from(select.options).map(opt => ({
      value: opt.value,
      text: opt.text,
      selected: opt.selected
    }));

    // Afficher l'√©tat de chargement
    select.innerHTML = '';
    const loadingOption = new Option('Chargement...', '', true, true);
    loadingOption.disabled = true;
    select.appendChild(loadingOption);
    select.disabled = false; // IMPORTANT: Toujours activer pendant le chargement

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      
      console.log(`‚úÖ Donn√©es re√ßues pour ${url}:`, data.length, '√©l√©ments');
      optionsCache[cacheKey] = data;
      
      // Peupler le select
      populateSelect(select, data, valueField, textField);
      
      // Restaurer la valeur pr√©c√©dente si elle existe
      if (currentValue && data.some(item => item[valueField] === currentValue)) {
        select.value = currentValue;
        console.log(`‚úÖ Valeur restaur√©e pour ${select.id}:`, currentValue);
      }
      
      return data;
    } catch (err) {
      console.error('‚ùå Erreur:', err);
      
      // Restaurer les options pr√©c√©dentes en cas d'erreur
      select.innerHTML = '';
      currentOptions.forEach(opt => {
        const option = new Option(opt.text, opt.value, opt.selected, opt.selected);
        select.appendChild(option);
      });
      
      select.disabled = false;
      return [];
    }
  }

  function populateSelect(select, data, valueField, textField) {
    select.innerHTML = '';
    
    // Toujours ajouter l'option vide
    const emptyOption = new Option('-- S√©lectionner --', '');
    select.appendChild(emptyOption);
    
    if (data && data.length > 0) {
      console.log(`üìù Peupler ${select.id} avec ${data.length} options`);
      
      data.forEach(item => {
        const option = new Option(item[textField], item[valueField]);
        select.appendChild(option);
      });
      
      select.disabled = false;
    } else {
      console.warn(`‚ö†Ô∏è Aucune donn√©e pour ${select.id}`);
      select.disabled = false; // Toujours activer m√™me si vide
    }
  }

  async function fetchStats(paramsObj) {
    // Nettoyer les param√®tres vides
    const cleanParams = {};
    Object.entries(paramsObj).forEach(([key, value]) => {
      if (value && value.trim() !== '') {
        cleanParams[key] = value;
      }
    });

    const key = JSON.stringify(cleanParams);
    if (statsCache[key]) {
      console.log('‚úÖ Utilisation du cache stats');
      return statsCache[key];
    }

    const params = new URLSearchParams(cleanParams);
    const url = `/stats?${params}&_cb=${Date.now()}`;
    console.log('üìä Requ√™te stats:', url);
    
    const response = await fetch(url);
    const data = await response.json();
    
    statsCache[key] = data;
    return data;
  }

  /**
 * Formate un nombre : ajoute des espaces pour les milliers et g√®re les d√©cimales
 * @param {number} num - Le nombre √† formater
 * @param {number} minDecimals - Minimum de d√©cimales (d√©faut 0)
 * @param {number} maxDecimals - Maximum de d√©cimales (d√©faut 2 pour √©viter les 15.510000)
 */
function formatNumber(num, minDecimals = 0, maxDecimals = 2) {
    if (num === undefined || num === null || isNaN(num)) return '‚Äî';
    
    return new Intl.NumberFormat('fr-FR', {
        minimumFractionDigits: minDecimals,
        maximumFractionDigits: maxDecimals
    }).format(num);
}

// 2. VOTRE M√âTHODE updateStats MISE √Ä JOUR
async function updateStats() {
    showLoader();
    try {
        const paramsObj = {
            region: getSelectValue('region'),
            departement: getSelectValue('departement'),
            commune: getSelectValue('commune'),
            zd: getSelectValue('zd')
        };

        console.log('üìä PARAMS pour stats:', paramsObj);
        const data = await fetchStats(paramsObj);

        console.log('‚úÖ DONN√âES STATS RE√áUES:', data);
        // console.log("Structure mainStats (Filtre):", data.mainStats);
        // console.log("Structure populationStats (Filtre):", data.populationStats);

        // Mettre √† jour tous les spans
        Object.entries(statsSpans).forEach(([spanId, dataKey]) => {
            const element = document.getElementById(spanId);
            if (!element) return;

            // R√©cup√©ration de la valeur brute
            let value = data;
            // console.log(`[MAP] ${dataKey} => SPAN ${spanId}:`, value);

            if (dataKey.includes('.')) {
                const keys = dataKey.split('.');
                keys.forEach(key => {
                    value = value ? value[key] : undefined;
                });
            } else {
                value = data[dataKey];
            }

            // --- D√âBUT DES MODIFICATIONS DE FORMATAGE ---
            
            // Cas 1 : Pourcentages (Taux, Proportion...)
            if (['tauxProgressionSpan', 'agriSpan', 'enfantSpan'].includes(spanId) && value !== undefined) {
                // Affiche : "12,5 %" ou "1 200 %"
                element.textContent = formatNumber(value, 0, 2) + ' %';
            } 
            // Cas 2 : Valeurs d√©cimales pr√©cises (Ratios, Parit√©) - Remplace toFixed(2)
            else if (['rMasculiniteSpan', 'pa49Span'].includes(spanId) && value !== undefined) {
                // Affiche : "100,00" ou "0,50" (Force 2 d√©cimales avec virgule)
                element.textContent = formatNumber(value, 2, 2);
            } 
            // Cas 3 : Nombres standards (Population, M√©nages) - Entiers
            else if (value !== undefined && value !== null) {
                // Affiche : "1 000 000" (Force 0 d√©cimales pour les entiers, ou max 2 si c'est une moyenne)
                // Si c'est un entier pur (nb habitants), on met maxDecimals √† 0
                const isInteger = [
                    'menEnumeresSpan', 'menDenombresSpan', 'popCartoSpan', 
                    'grandMenagesSpan', 'menagesSoloSpan', 'popRuraleSpan',
                    'popTotaleSpan', 'totalHommesSpan', 'totalFemmesSpan'
                ].includes(spanId);

                element.textContent = formatNumber(value, 0, isInteger ? 0 : 2);
            } 
            // Cas 4 : Valeur vide
            else {
                element.textContent = '‚Äî';
            }
        });

    } catch (err) {
        console.error('‚ùå Erreur dans updateStats:', err);
    } finally {
        hideLoader();
    }
}

  const debouncedUpdateStats = debounce(updateStats, 200);

  // ‚úÖ √âCOUTEURS CORRIG√âS - Gestion am√©lior√©e des changements
  if (isActiveSelect(selects.region)) {
    selects.region.addEventListener('change', async (e) => {
      console.log('üîò Region chang√©e:', e.target.value);
      
      // R√©initialiser les niveaux inf√©rieurs
      if (isActiveSelect(selects.departement)) {
        selects.departement.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.departement.disabled = false; // IMPORTANT: Toujours activer
      }
      
      if (isActiveSelect(selects.commune)) {
        selects.commune.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.commune.disabled = false;
      }
      
      if (isActiveSelect(selects.zd)) {
        selects.zd.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.zd.disabled = false;
      }

      if (selects.region.value) {
        console.log('üì• Chargement d√©partements pour r√©gion:', selects.region.value);
        await loadOptions(`/api/location/departements?region=${selects.region.value}`, 
                          selects.departement, 'code_departement', 'departement');
      }

      if (selects.refreshBtn) {
  selects.refreshBtn.addEventListener('click', async () => {
    console.log('üîÑ Rafra√Æchissement forc√© demand√©');
    
    showLoader();
    
    // 1. Vider tous les caches client
    Object.keys(optionsCache).forEach(k => delete optionsCache[k]);
    Object.keys(statsCache).forEach(k => delete statsCache[k]);
    
    // 2. Forcer le rechargement des donn√©es
    await updateStats();
    
    // 3. Recharger les options si n√©cessaire
    if (isActiveSelect(selects.region) && selects.region.value) {
      await loadOptions(`/api/location/departements?region=${selects.region.value}`, 
                       selects.departement, 'code_departement', 'departement');
    }
    
    hideLoader();
  });
}
      
      debouncedUpdateStats();
    });
  }

  if (isActiveSelect(selects.departement)) {
    selects.departement.addEventListener('change', async (e) => {
      console.log('üîò D√©partement chang√©:', e.target.value);
      
      // R√©initialiser les niveaux inf√©rieurs
      if (isActiveSelect(selects.commune)) {
        selects.commune.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.commune.disabled = false;
      }
      
      if (isActiveSelect(selects.zd)) {
        selects.zd.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.zd.disabled = false;
      }

      if (selects.departement.value) {
        console.log('üì• Chargement communes pour d√©partement:', selects.departement.value);
        await loadOptions(`/api/location/communes?departement=${selects.departement.value}`, 
                          selects.commune, 'code_commune', 'commune');
      }
      
      debouncedUpdateStats();
    });
  }

  if (isActiveSelect(selects.commune)) {
    selects.commune.addEventListener('change', async (e) => {
      console.log('üîò Commune chang√©e:', e.target.value);
      
      // R√©initialiser ZD
      if (isActiveSelect(selects.zd)) {
        selects.zd.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.zd.disabled = false;
      }

      if (selects.commune.value) {
        console.log('üì• Chargement ZDs pour commune:', selects.commune.value);
        await loadOptions(`/api/location/zds?commune=${selects.commune.value}`, 
                          selects.zd, 'mo_zd', 'mo_zd');
      }
      
      debouncedUpdateStats();
    });
  }

  if (isActiveSelect(selects.zd)) {
    selects.zd.addEventListener('change', (e) => {
      console.log('üîò ZD chang√©e:', e.target.value);
      debouncedUpdateStats();
    });
  }

  // ‚úÖ INITIALISATION
  const userRole = '<%= user.role %>';
  console.log('üë§ R√¥le:', userRole);
  
  // Fonction pour initialiser Select2
  const initializeSelect2 = () => {
    if (typeof $ !== 'undefined' && $.fn.select2) {
      console.log('üîß Initialisation Select2...');
      
      // Attendre que tout soit charg√©
      setTimeout(() => {
        $('.form-select').each(function() {
          const $select = $(this);
          
          // Ne pas appliquer Select2 sur les selects d√©sactiv√©s ou verrouill√©s
          if (!$select.prop('disabled') && $select.find('option').length > 0) {
            $select.select2({
              placeholder: '-- S√©lectionner --',
              allowClear: true,
              width: '100%',
              theme: 'bootstrap-5',
              dropdownParent: $select.closest('.modal, .row') // Important pour le positionnement
            });
            
            // R√©appliquer les √©v√©nements apr√®s Select2
            const nativeSelect = $select[0];
            if (nativeSelect.id === 'region' || nativeSelect.id === 'departement' || 
                nativeSelect.id === 'commune' || nativeSelect.id === 'zd') {
              
              $select.on('select2:select', function(e) {
                console.log(`üéØ Select2: ${nativeSelect.id} s√©lectionn√©:`, e.params.data.id);
                // D√©clencher l'√©v√©nement change natif
                const event = new Event('change', { bubbles: true });
                nativeSelect.dispatchEvent(event);
              });
              
              $select.on('select2:clear', function() {
                console.log(`üéØ Select2: ${nativeSelect.id} cleared`);
                const event = new Event('change', { bubbles: true });
                nativeSelect.dispatchEvent(event);
              });
            }
          }
        });
        console.log('‚úÖ Select2 initialis√©');
      }, 500);
    } else {
      console.error('‚ùå Select2 non disponible!');
    }
  };

  // Fonction d'initialisation principale
  async function initializeDashboard() {
    const userRole = '<%= user.role %>';
    console.log('üë§ ROLE_GLOBAL initialisation...');
    try {
      // ===== ROLE_GLOBAL : Charger toutes les r√©gions et stats -- S√©lectionner --es =====
      if (userRole === 'ROLE_GLOBAL') {
        console.log('üìä Initialisation stats -- S√©lectionner --es ROLE_GLOBAL');
        // updateStats();  <--- Supprimer ou commenter cette ligne.

        // 1. Charger les r√©gions dans le select
        if (isActiveSelect(selects.region)) {
          if (selects.region.options.length <= 1) {
            await loadOptions('/api/location/regions', selects.region, 'code_region', 'region');
          }
        }
        
        // 2. Vider les autres selects
        if (isActiveSelect(selects.departement)) {
          selects.departement.innerHTML = '<option value="">-- S√©lectionner --</option>';
          selects.departement.disabled = false;
        }
        if (isActiveSelect(selects.commune)) {
          selects.commune.innerHTML = '<option value="">-- S√©lectionner --</option>';
          selects.commune.disabled = false;
        }
        if (isActiveSelect(selects.zd)) {
          selects.zd.innerHTML = '<option value="">-- S√©lectionner --</option>';
          selects.zd.disabled = false;
        }
        
        // 3. Charger LES STATS GLOBALES (sans filtres) UNE SEULE FOIS
        await updateStats(); // <--- Assurez-vous qu'il est ici et qu'il est attendu (await) si possible.

        console.log('‚úÖ ROLE_GLOBAL : Stats -- S√©lectionner --es charg√©es');
        return; // On sort pour ROLE_GLOBAL
      }
      
      // ===== LOGIQUE POUR LES AUTRES R√îLES (garder le code existant) =====
      const regionCode = getSelectValue('region');
      const deptCode = getSelectValue('departement');
      const communeCode = getSelectValue('commune');
      
      console.log('üîç Codes initiaux - R√©gion:', regionCode, 'D√©partement:', deptCode, 'Commune:', communeCode);
      console.log('üë§ R√¥le utilisateur:', userRole);
      
      
      
      // ===== ROLE_GLOBAL : Pr√©charger les r√©gions =====
      if (userRole === 'ROLE_GLOBAL' && isActiveSelect(selects.region)) {
        if (selects.region.options.length <= 1) { // Juste l'option vide
          console.log('üì• Chargement initial des r√©gions pour ROLE_GLOBAL');
          await loadOptions('/api/location/regions', selects.region, 'code_region', 'region');
        }
      }
      
      // ===== ROLE_REGIONAL : Charger les d√©partements de sa r√©gion =====
      if (userRole === 'ROLE_REGIONAL' && regionCode && isActiveSelect(selects.departement)) {
        console.log('üì• ROLE_REGIONAL - Chargement d√©partements pour r√©gion:', regionCode);
        await loadOptions(`/api/location/departements?region=${regionCode}`, 
                         selects.departement, 'code_departement', 'departement');
      }
      
      // ===== ROLE_DEPARTEMENTAL : Charger d√©partements puis communes =====
      if (userRole === 'ROLE_DEPARTEMENTAL' && regionCode) {
        console.log('üì• ROLE_DEPARTEMENTAL - Chargement d√©partements pour r√©gion:', regionCode);
        
        // Charger les d√©partements (m√™me si verrouill√©, pour afficher le nom)
        if (isActiveSelect(selects.departement)) {
          await loadOptions(`/api/location/departements?region=${regionCode}`, 
                           selects.departement, 'code_departement', 'departement');
          
          // Pr√©s√©lectionner le d√©partement
          if (deptCode && deptCode.trim() !== '') {
            selects.departement.value = deptCode;
            console.log('‚úÖ ROLE_DEPARTEMENTAL - D√©partement pr√©s√©lectionn√©:', deptCode);
          }
        }
        
        // Charger les communes pour ce d√©partement
        if (deptCode && isActiveSelect(selects.commune)) {
          console.log('üì• ROLE_DEPARTEMENTAL - Chargement communes pour d√©partement:', deptCode);
          await loadOptions(`/api/location/communes?departement=${deptCode}`, 
                           selects.commune, 'code_commune', 'commune');
        }
      }
      
      // ===== ROLE_COMMUNAL : Charger d√©partements, communes puis ZDs =====
      if (userRole === 'ROLE_COMMUNAL' && regionCode) {
        console.log('üì• ROLE_COMMUNAL - Initialisation compl√®te');
        
        // Charger les d√©partements
        if (isActiveSelect(selects.departement)) {
          await loadOptions(`/api/location/departements?region=${regionCode}`, 
                           selects.departement, 'code_departement', 'departement');
          
          if (deptCode && deptCode.trim() !== '') {
            selects.departement.value = deptCode;
            console.log('‚úÖ ROLE_COMMUNAL - D√©partement pr√©s√©lectionn√©:', deptCode);
          }
        }
        
        // Charger les communes
        if (deptCode && isActiveSelect(selects.commune)) {
          await loadOptions(`/api/location/communes?departement=${deptCode}`, 
                           selects.commune, 'code_commune', 'commune');
          
          if (communeCode && communeCode.trim() !== '') {
            selects.commune.value = communeCode;
            console.log('‚úÖ ROLE_COMMUNAL - Commune pr√©s√©lectionn√©e:', communeCode);
          }
        }
        
        // Charger les ZDs pour cette commune
        if (communeCode && isActiveSelect(selects.zd)) {
          console.log('üì• ROLE_COMMUNAL - Chargement ZDs pour commune:', communeCode);
          await loadOptions(`/api/location/zds?commune=${communeCode}`, 
                           selects.zd, 'mo_zd', 'mo_zd');
        }
      }
      
      // ===== LOGIQUE G√âN√âRIQUE (pour tous les autres cas) =====
      // Si on a une r√©gion et pas encore g√©r√© ci-dessus
      if (regionCode && regionCode.trim() !== '' && 
          !['ROLE_DEPARTEMENTAL', 'ROLE_COMMUNAL'].includes(userRole) &&
          isActiveSelect(selects.departement)) {
        console.log('üì• Chargement d√©partements pour r√©gion:', regionCode);
        await loadOptions(`/api/location/departements?region=${regionCode}`, 
                         selects.departement, 'code_departement', 'departement');
        
        // Si on a un d√©partement dans les donn√©es EJS, le pr√©s√©lectionner
        if (deptCode && deptCode.trim() !== '' && selects.departement) {
          selects.departement.value = deptCode;
          console.log('‚úÖ D√©partement pr√©s√©lectionn√©:', deptCode);
          
          // Si d√©partement s√©lectionn√©, charger les communes
          if (isActiveSelect(selects.commune) && selects.departement.value) {
            console.log('üì• Chargement communes pour d√©partement:', selects.departement.value);
            await loadOptions(`/api/location/communes?departement=${selects.departement.value}`, 
                             selects.commune, 'code_commune', 'commune');
            
            // Si on a une commune dans les donn√©es EJS, la pr√©s√©lectionner
            if (communeCode && communeCode.trim() !== '' && selects.commune) {
              selects.commune.value = communeCode;
              console.log('‚úÖ Commune pr√©s√©lectionn√©e:', communeCode);
              
              // Si commune s√©lectionn√©e, charger les ZDs
              if (isActiveSelect(selects.zd) && selects.commune.value) {
                console.log('üì• Chargement ZDs pour commune:', selects.commune.value);
                await loadOptions(`/api/location/zds?commune=${selects.commune.value}`, 
                                  selects.zd, 'mo_zd', 'mo_zd');
              }
            }
          }
        }
      }
      
      // ===== Initialiser les stats (pour TOUS les r√¥les) =====
      console.log('üìä Initialisation des stats...');
      await updateStats();
      
      // Initialiser Select2
      
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'initialisation:', error);
    }
  }

  // D√©marrer l'initialisation apr√®s un court d√©lai
  setTimeout(() => {
    initializeDashboard();
  }, 100);
});
</script>
<script>  
// D√©clarer les variables globales
let regionMap = null;
let departementMap = null;
let regionLayer = null;
let departementLayer = null;
let regionStats = null;
let departementStats = null;

// Couleurs pour les gradients
const COLOR_SCALES = {
    green: ['#CAEAA9E0', '#6DC645FF', '#54BD41FF', '#36B23DFF', '#12A537FF']
};

// Fonction pour cr√©er une carte avec fond uni
function createCleanMap(containerId, title, colorScale = 'green', center = [17.6078, 8.0817], zoom = 5.5) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error('‚ùå Conteneur non trouv√©:', containerId);
        return null;
    }
    
    // Vider et pr√©parer le conteneur
    container.innerHTML = `
        <div class="map-header">
            <h6 class="map-title">${title}</h6>
        </div>
        <div class="map-container" id="${containerId}-inner"></div>
        <div class="map-legend" id="${containerId}-legend"></div>
    `;
    
    const mapContainer = document.getElementById(`${containerId}-inner`);
    
    // Appliquer le style
    mapContainer.style.backgroundColor = '#f8fafc';
    mapContainer.style.border = '1px solid #e2e8f0';
    mapContainer.style.borderRadius = '4px';
    mapContainer.style.height = '400px';
    mapContainer.style.width = '100%';
    mapContainer.style.position = 'relative';
    
    try {
        // Cr√©er la carte
        const map = L.map(`${containerId}-inner`, {
            center: center,
            zoom: zoom,
            zoomControl: true,
            attributionControl: false,
            scrollWheelZoom: true,
            dragging: true,
            doubleClickZoom: true
        });
        
        console.log('‚úÖ Carte cr√©√©e:', containerId);
        return map;
        
    } catch (error) {
        console.error('‚ùå Erreur cr√©ation carte:', containerId, error);
        return null;
    }
}

// Fonction pour obtenir une couleur bas√©e sur un pourcentage (0-100%)
function getColorForValue(percent) {
    if (percent === null || percent === undefined) return '#cccccc';
    
    const colors = COLOR_SCALES.green;
    
    if (percent <= 25) return colors[0];
    if (percent <= 50) return colors[1];
    if (percent <= 75) return colors[2];
    if (percent <= 90) return colors[3];
    return colors[4]; // 91-100%
}

// Fonction pour cr√©er une l√©gende
function createLegend(containerId, title = 'Taux de progression') {
    const legendContainer = document.getElementById(`${containerId}-legend`);
    if (!legendContainer) return;
    
    const colors = COLOR_SCALES.green;
    
    legendContainer.innerHTML = `
        <div class="legend">
            <div class="legend-title">${title}</div>
            <div class="legend-scale">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${colors[0]}"></span>
                    <span class="legend-label">0-25%</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${colors[1]}"></span>
                    <span class="legend-label">26-50%</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${colors[2]}"></span>
                    <span class="legend-label">51-75%</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${colors[3]}"></span>
                    <span class="legend-label">76-90%</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${colors[4]}"></span>
                    <span class="legend-label">91-100%</span>
                </div>
            </div>
        </div>
    `;
}

// Fonction pour charger les statistiques par r√©gion
async function loadRegionStats() {
    try {
        console.log('üìä Chargement des statistiques par r√©gion...');
        
        // Utiliser votre service existant
        const response = await fetch('/api/stats/regions');
        if (!response.ok) {
            throw new Error(`API R√©gions: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Statistiques r√©gions charg√©es:', data.length, 'r√©gions');
        
        // Calculer les pourcentages
        regionStats = data.map(item => ({
            nom: item.regionName || item.region,
            code: item.regionCode,
            populationCarto: item.populationCarto || 0,
            populationCollectee: item.populationCollectee || 0,
            pourcentage: item.populationCarto > 0 
                ? Math.round((item.populationCollectee / item.populationCarto) * 100)
                : 0
        }));
        
        return regionStats;
        
    } catch (error) {
        console.error('‚ùå Erreur chargement stats r√©gions:', error);
        
        // Donn√©es de d√©mo en cas d'erreur
        regionStats = [
            { nom: 'AGADEZ', code: 'NER001', populationCarto: 50000, populationCollectee: 45000, pourcentage: 90 },
            { nom: 'DIFFA', code: 'NER002', populationCarto: 40000, populationCollectee: 30000, pourcentage: 75 },
            { nom: 'DOSSO', code: 'NER003', populationCarto: 60000, populationCollectee: 48000, pourcentage: 80 },
            { nom: 'MARADI', code: 'NER004', populationCarto: 70000, populationCollectee: 56000, pourcentage: 80 },
            { nom: 'NIAMEY', code: 'NER005', populationCarto: 100000, populationCollectee: 95000, pourcentage: 95 },
            { nom: 'TAHOUA', code: 'NER006', populationCarto: 55000, populationCollectee: 44000, pourcentage: 80 },
            { nom: 'TILLABERI', code: 'NER007', populationCarto: 65000, populationCollectee: 52000, pourcentage: 80 },
            { nom: 'ZINDER', code: 'NER008', populationCarto: 80000, populationCollectee: 64000, pourcentage: 80 }
        ];
        
        return regionStats;
    }
}

// Fonction pour charger les statistiques par d√©partement
async function loadDepartementStats() {
    try {
        console.log('üìä Chargement des statistiques par d√©partement...');
        
        const response = await fetch('/api/stats/departements');
        if (!response.ok) {
            throw new Error(`API D√©partements: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Statistiques d√©partements charg√©es:', data.length, 'd√©partements');
        
        // Calculer les pourcentages
        departementStats = data.map(item => ({
            nom: item.departementName || item.departement,
            code: item.departementCode,
            region: item.region,
            populationCarto: item.populationCarto || 0,
            populationCollectee: item.populationCollectee || 0,
            pourcentage: item.populationCarto > 0 
                ? Math.round((item.populationCollectee / item.populationCarto) * 100)
                : 0
        }));
        
        return departementStats;
        
    } catch (error) {
        console.error('‚ùå Erreur chargement stats d√©partements:', error);
        
        // Donn√©es de d√©mo
        departementStats = [
            { nom: 'ABALA', code: 'NER006001', region: 'TILLABERI', populationCarto: 15000, populationCollectee: 12000, pourcentage: 80 },
            { nom: 'AGUI√â', code: 'NER004001', region: 'MARADI', populationCarto: 18000, populationCollectee: 14400, pourcentage: 80 },
            { nom: 'BIRNI N\'KONNI', code: 'NER004002', region: 'MARADI', populationCarto: 22000, populationCollectee: 17600, pourcentage: 80 },
            // Ajouter d'autres d√©partements...
        ];
        
        return departementStats;
    }
}

// Fonction pour cr√©er la carte des r√©gions avec pourcentages
function createRegionMap(regionData, stats) {
    if (!regionData || !regionData.features) {
        console.error('‚ùå Donn√©es r√©gions manquantes');
        return;
    }
    
    // Cr√©er la carte
    regionMap = createCleanMap('map-regions', 'Progression par R√©gion', 'green', [17.6078, 8.0817], 7);
    if (!regionMap) return;
    
    // Cr√©er la l√©gende
    createLegend('map-regions', 'Taux de progression');
    
    // Associer les statistiques aux r√©gions
    const regionDataWithStats = regionData.features.map(feature => {
        const regionName = feature.properties.NOMREG;
        const stat = stats.find(s => s.nom === regionName);
        const pourcentage = stat ? stat.pourcentage : 0;
        
        return {
            ...feature,
            properties: {
                ...feature.properties,
                stat: stat,
                pourcentage: pourcentage
            }
        };
    });
    
    // Cr√©er la couche choropl√®the
    regionLayer = L.geoJSON(regionDataWithStats, {
        style: function(feature) {
            const pourcentage = feature.properties.pourcentage || 0;
            return {
                fillColor: getColorForValue(pourcentage),
                weight: 2,
                opacity: 1,
                color: '#ffffff',
                fillOpacity: 0.8,
                className: 'region-polygon'
            };
        },
        onEachFeature: function(feature, layer) {
            const regionName = feature.properties.NOMREG;
            const stat = feature.properties.stat || {};
            const pourcentage = feature.properties.pourcentage || 0;
            
            // Afficher le pourcentage directement sur la carte
            const center = layer.getBounds().getCenter();
            const label = L.divIcon({
                html: `
                    <div style="
                        background: rgba(255, 255, 255, 0.9);
                        border-radius: 4px;
                        padding: 4px 8px;
                        font-weight: 700;
                        font-size: 14px;
                        color: #2d3748;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        border: 2px solid ${getColorForValue(pourcentage)};
                    ">
                        ${pourcentage}%
                    </div>
                `,
                iconSize: [60, 30],
                className: 'region-label'
            });
            
            L.marker(center, { 
                icon: label,
                interactive: false,
                zIndexOffset: 1000
            }).addTo(regionMap);
            
            // Popup d√©taill√©
            const popupContent = `
                <div style="min-width: 250px; font-family: system-ui, sans-serif;">
                    <div style="
                        background-color: #F8BE28FF ;
                        color: white;
                        padding: 12px 16px;
                        margin: -16px -16px 12px -16px;
                        border-radius: 4px 4px 0 0;
                    ">
                        <strong style="font-size: 16px;">${regionName}</strong>
                    </div>
                    <div style="padding: 10px 0;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Taux de progression</div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    border-radius: 50%;
                                    background: conic-gradient(${getColorForValue(pourcentage)} ${pourcentage * 3.6}deg, #e2e8f0 0deg);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    position: relative;
                                ">
                                    <div style="
                                        width: 60px;
                                        height: 60px;
                                        background: white;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 20px;
                                        font-weight: 700;
                                        color: #2d3748;
                                    ">
                                        ${pourcentage}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr style="margin: 15px 0; border: none; border-top: 1px solid #e2e8f0;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">Population cartographi√©e</div>
                                <div style="font-size: 18px; font-weight: 600; color: #2d3748;">${formatNumber(stat.populationCarto || 0)}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">Population collect√©e</div>
                                <div style="font-size: 18px; font-weight: 600; color: #2d3748;">${formatNumber(stat.populationCollectee || 0)}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 11px; color: #a0aec0; text-align: center;">
                            Code: ${feature.properties.rowcacode1 || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            layer.bindPopup(popupContent);
            
            // Tooltip au survol
            layer.bindTooltip(`
                <div style="font-weight: 600; font-size: 13px;">${regionName}</div>
                <div style="font-size: 12px; color: #666;">${pourcentage}% de progression</div>
                <div style="font-size: 11px; color: #999;">${formatNumber(stat.populationCollectee || 0)}/${formatNumber(stat.populationCarto || 0)}</div>
            `, {
                direction: 'top',
                offset: [0, -10],
                className: 'custom-tooltip',
                sticky: true
            });
        }
    }).addTo(regionMap);
    
    // Ajuster la vue

const bounds = regionLayer.getBounds();
if (bounds.isValid()) {
    // 1. fitBounds initial avec padding minimal
    regionMap.fitBounds(bounds, {
        padding: [15, 15],
        maxZoom: 7.5,
        animate: true
    });
    
    // 2. Zoom progressif tr√®s doux
    setTimeout(() => {
        const currentZoom = regionMap.getZoom();
        // Essayer diff√©rentes valeurs pour trouver le bon r√©glage
        const zoomIncrement = 0.3; // ‚Üê TR√àS DOUX (essayez 0.2, 0.3, 0.4)
        
        if (currentZoom < 7) {
            regionMap.setZoom(currentZoom + zoomIncrement, {
                animate: true,
                duration: 0.5
            });
        }
    }, 400);
}
    console.log('‚úÖ Carte r√©gions cr√©√©e avec', regionDataWithStats.length, 'r√©gions');
}

// Fonction pour cr√©er la carte des d√©partements avec pourcentages
function createDepartementMap(departementData, stats) {
    if (!departementData || !departementData.features) {
        console.error('‚ùå Donn√©es d√©partements manquantes');
        return;
    }
    
    // Cr√©er la carte
    departementMap = createCleanMap('map-departements', 'Progression par D√©partement', 'green', [17.6078, 8.0817], 6);
    if (!departementMap) return;
    
    // Cr√©er la l√©gende
    createLegend('map-departements', 'Taux de progression');
    
    // Associer les statistiques aux d√©partements
    const departementDataWithStats = departementData.features.map(feature => {
        const departementName = feature.properties.NOMDEP;
        const stat = stats.find(s => s.nom === departementName);
        const pourcentage = stat ? stat.pourcentage : 0;
        
        return {
            ...feature,
            properties: {
                ...feature.properties,
                stat: stat,
                pourcentage: pourcentage
            }
        };
    });
    
    // Cr√©er la couche choropl√®the
    departementLayer = L.geoJSON(departementDataWithStats, {
        style: function(feature) {
            const pourcentage = feature.properties.pourcentage || 0;
            return {
                fillColor: getColorForValue(pourcentage),
                weight: 1,
                opacity: 1,
                color: '#ffffff',
                fillOpacity: 0.7,
                className: 'departement-polygon'
            };
        },
        onEachFeature: function(feature, layer) {
            const departementName = feature.properties.NOMDEP;
            const stat = feature.properties.stat || {};
            const pourcentage = feature.properties.pourcentage || 0;
            const regionName = feature.properties.adm_01 || stat.region || '';
            
            // Popup d√©taill√©
            const popupContent = `
                <div style="min-width: 250px; font-family: system-ui, sans-serif;">
                    <div style="
                        background-color: #F8BE28FF ;
                        color: white;
                        padding: 12px 16px;
                        margin: -16px -16px 12px -16px;
                        border-radius: 4px 4px 0 0;
                    ">
                        <div>
                            <strong style="font-size: 16px;">${departementName}</strong>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">
                                R√©gion: ${regionName}
                            </div>
                        </div>
                    </div>
                    <div style="padding: 10px 0;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Taux de progression</div>
                            <div style="font-size: 32px; font-weight: 700; color: #2d3748;">
                                ${pourcentage}%
                            </div>
                        </div>
                        
                        <hr style="margin: 15px 0; border: none; border-top: 1px solid #e2e8f0;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">Population cartographi√©e</div>
                                <div style="font-size: 16px; font-weight: 600; color: #2d3748;">${formatNumber(stat.populationCarto || 0)}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">Population collect√©e</div>
                                <div style="font-size: 16px; font-weight: 600; color: #2d3748;">${formatNumber(stat.populationCollectee || 0)}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 11px; color: #a0aec0; text-align: center;">
                            Code: ${feature.properties.rowcacode2 || 'N/A'} | 
                            Code D√©pt: ${feature.properties.DepCodDep || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            layer.bindPopup(popupContent);
            
            // Tooltip au survol
            layer.bindTooltip(`
                <div style="font-weight: 600; font-size: 12px;">${departementName}</div>
                <div style="font-size: 11px; color: #666;">${pourcentage}% | ${regionName}</div>
            `, {
                direction: 'top',
                offset: [0, -5],
                className: 'custom-tooltip',
                sticky: true
            });
        }
    }).addTo(departementMap);
    
    // Ajuster la vue
    const bounds = departementLayer.getBounds();
    if (bounds.isValid()) {
        departementMap.fitBounds(bounds, {
            padding: [30, 30],
            maxZoom: 8,
            animate: true
        });
    }
    
    console.log('‚úÖ Carte d√©partements cr√©√©e avec', departementDataWithStats.length, 'd√©partements');
}

// Formatage des nombres
function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1).replace('.', ',') + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1).replace('.', ',') + 'k';
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
}

// Fonction principale pour cr√©er les deux cartes
async function createBothMaps() {
    console.log('üó∫Ô∏è Cr√©ation des cartes de progression...');
    
    try {
        // Charger toutes les donn√©es en parall√®le
        const [regionGeoResponse, departementGeoResponse, regionStatsData, departementStatsData] = await Promise.all([
            fetch('/api/regions'),
            fetch('/api/departements'),
            loadRegionStats(),
            loadDepartementStats()
        ]);
        
        // V√©rifier les r√©ponses g√©ographiques
        if (!regionGeoResponse.ok || !departementGeoResponse.ok) {
            throw new Error('Erreur chargement donn√©es g√©ographiques');
        }
        
        const regionGeoData = await regionGeoResponse.json();
        const departementGeoData = await departementGeoResponse.json();
        
        console.log('‚úÖ Donn√©es charg√©es:', {
            r√©gions: regionGeoData.features?.length || 0,
            d√©partements: departementGeoData.features?.length || 0,
            statsR√©gions: regionStatsData?.length || 0,
            statsD√©partements: departementStatsData?.length || 0
        });
        
        // Cr√©er la carte des r√©gions
        createRegionMap(regionGeoData, regionStatsData);
        
        // Cr√©er la carte des d√©partements
        createDepartementMap(departementGeoData, departementStatsData);
        
        console.log('‚úÖ Les deux cartes sont pr√™tes');
        
    } catch (error) {
        console.error('‚ùå Erreur cr√©ation cartes:', error);
        showError(error);
    }
}

// Fonction pour afficher les erreurs
function showError(error) {
    const errorHtml = `
        <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            color: #718096;
            font-family: sans-serif;
            text-align: center;
            padding: 20px;
        ">
            <div style="font-size: 48px; margin-bottom: 15px;">üó∫Ô∏è</div>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 10px; color: #4a5568;">
                Impossible de charger les cartes
            </div>
            <div style="font-size: 14px; color: #a0aec0; margin-bottom: 20px;">
                ${error.message || 'Une erreur est survenue'}
            </div>
            <button onclick="window.location.reload()" style="
                padding: 8px 20px;
                background: #4299e1;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                transition: background 0.2s;
            ">
                R√©essayer
            </button>
        </div>
    `;
    
    // Afficher dans les deux conteneurs
    ['map-regions', 'map-departements'].forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = errorHtml;
        }
    });
}

// Initialisation
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üèóÔ∏è Initialisation des cartes...');
    
    // V√©rifier que Leaflet est charg√©
    if (typeof L === 'undefined') {
        console.error('‚ùå Leaflet non charg√©');
        showError(new Error('Biblioth√®que cartographique manquante'));
        return;
    }
    
    // Cr√©er les cartes
    await createBothMaps();
    
    console.log('‚úÖ Dashboard cartographique pr√™t');
});

// Redimensionnement automatique
window.addEventListener('resize', function() {
    clearTimeout(window.resizeTimer);
    window.resizeTimer = setTimeout(function() {
        if (regionMap) regionMap.invalidateSize();
        if (departementMap) departementMap.invalidateSize();
        console.log('üîÑ Cartes redimensionn√©es');
    }, 250);
});

// API endpoints n√©cessaires c√¥t√© serveur
/* 
// Dans votre fichier de routes (ex: routes/api.js)

// 1. Pour les statistiques par r√©gion
router.get('/stats/regions', async (req, res) => {
    try {
        const stats = await getPopulationByRegion(); // Votre fonction existante
        res.json(stats);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erreur serveur' });
    }
});

// 2. Pour les statistiques par d√©partement (√† cr√©er)
router.get('/stats/departements', async (req, res) => {
    try {
        const sql = `
            SELECT
                code_departement AS departementCode,
                departement AS departementName,
                region,
                SUM(xm20) AS populationCarto,
                SUM(xm40) AS populationCollectee
            FROM tmenage
            GROUP BY code_departement, departement, region
            ORDER BY region, departement ASC
        `;
        const rows = await menageDB.query(sql, { type: QueryTypes.SELECT });
        
        const result = rows.map(r => ({
            departement: r.departementName,
            region: r.region,
            populationCarto: Number(r.populationCarto || 0),
            populationCollectee: Number(r.populationCollectee || 0)
        }));
        
        res.json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erreur serveur' });
    }
});
*/
</script>

<!-- Style CSS -->
<style>
    /* Conteneurs des cartes */
    .map-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 15px;
        margin-bottom: 20px;
        transition: box-shadow 0.3s ease;
    }
    
    .map-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    /* En-t√™te de la carte */
    .map-header {
        margin-bottom: 15px;
    }
    
    .map-title {
        font-size: 16px;
        font-weight: 600;
        color: #2d3748;
        margin: 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    /* Conteneur Leaflet */
    .map-container {
        height: 400px;
        width: 100%;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
    }
    
    /* L√©gende */
    .legend {
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        font-size: 12px;
        display: inline-block;
    }
    
    .legend-title {
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 10px;
        font-size: 13px;
    }
    
    .legend-scale {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-color {
        width: 24px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    .legend-label {
        color: #718096;
        font-size: 12px;
        min-width: 50px;
    }
    
    /* Styles Leaflet */
    .leaflet-container {
        background: #f8fafc !important;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif !important;
    }
    
    /* Labels des pourcentages sur les r√©gions */
    .region-label {
        pointer-events: none !important;
    }
    
    /* Tooltips personnalis√©s */
    .custom-tooltip {
        background: white !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 6px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        padding: 8px 12px !important;
        font-size: 12px !important;
        font-weight: 500 !important;
    }
    
    .custom-tooltip:before {
        border-top-color: white !important;
    }
    
    /* Popups am√©lior√©s */
    .leaflet-popup-content-wrapper {
        border-radius: 8px !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        border: none !important;
        overflow: hidden;
    }
    
    .leaflet-popup-tip {
        box-shadow: none !important;
    }
    
    /* Animation des polygones */
    .region-polygon, .departement-polygon {
        transition: fill-opacity 0.3s ease, stroke-width 0.3s ease;
    }
    
    .region-polygon:hover, .departement-polygon:hover {
        fill-opacity: 0.9 !important;
        stroke-width: 3px !important;
        cursor: pointer;
    }
</style>