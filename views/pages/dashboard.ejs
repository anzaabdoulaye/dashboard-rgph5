<div id="globalLoader" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.7);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  opacity: 0.5;
">
  <div style="text-align: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <div style="margin-top: 10px; font-weight: bold;">Chargement...</div>
  </div>
</div>


<div class="row">
	<div class="col-12">
		<div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
			<h4 class="mb-sm-0">Tableau de bord du RGPH-5</h4>
			<div class="page-title-right">
				<ol class="breadcrumb m-0">
					<li class="breadcrumb-item active">Indicateurs</li>
				</ol>

			</div>

		</div>
	</div>
	<div class="col-12">
  <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent p-3 rounded shadow-sm">
    <div class="row g-3 w-100">
      
<div class="row">
  <!-- R√©gion -->
  <div class="col-3">
    <label>R√©gion</label>
    <% if (user.canChangeRegion) { %>
      <!-- ROLE_GLOBAL : Select actif avec options pr√©charg√©es -->
      <select id="region" class="form-select">
        <option value="">-- S√©lectionner --</option>
        <% selects.regions.forEach(region => { %>
          <option value="<%= region.code_region %>"><%= region.region %></option>
        <% }); %>
      </select>
    <% } else { %>
      <!-- R√¥les REGIONAL, DEPARTEMENTAL, COMMUNAL : R√©gion fix√©e -->
      <% const defaultRegion = user.defaultRegion || selects.regions[0]?.code_region || ''; %>
      <% const defaultRegionName = selects.regions[0]?.region || 'R√©gion non disponible'; %>
      
      <input type="hidden" id="region" value="<%= defaultRegion %>">
      <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
        <%= defaultRegionName %>
      </div>
    <% } %>
  </div>
  
  <!-- D√©partement -->
  <!-- D√©partement -->
<div class="col-3">
  <label>D√©partement</label>
  <% if (user.canChangeDepartement) { %>  <!-- CHANGER canChangeRegion EN canChangeDepartement -->
    <select id="departement" class="form-select">
      <option value="">-- S√©lectionner --</option>
    </select>
  <% } else { %>
    <% const defaultDept = user.defaultDepartement || selects.departements[0]?.code_departement || ''; %>
    <% const defaultDeptName = selects.departements[0]?.departement || 'D√©partement non disponible'; %>
    
    <input type="hidden" id="departement" value="<%= defaultDept %>">
    <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
      <%= defaultDeptName %>
    </div>
  <% } %>
</div>
  
  <!-- Commune -->
  <div class="col-3">
    <label>Commune</label>
    <% if (user.canChangeCommune) { %>
      <!-- ROLE_GLOBAL, REGIONAL, DEPARTEMENTAL : Select actif -->
      <select id="commune" class="form-select">
        <option value="">-- S√©lectionner --</option>
      </select>
    <% } else { %>
      <!-- ROLE_COMMUNAL : Commune fix√©e -->
      <% const defaultCommune = user.defaultCommune || selects.communes[0]?.code_commune || ''; %>
      <% const defaultCommuneName = selects.communes[0]?.commune || 'Commune non disponible'; %>
      
      <input type="hidden" id="commune" value="<%= defaultCommune %>">
      <div class="form-control-plaintext" style="padding:0.5rem; border:1px solid #ddd; background:#f8f9fa;">
        <%= defaultCommuneName %>
      </div>
    <% } %>
  </div>
  
  <!-- ZD -->
  <div class="col-3">
    <label>Zone de d√©nombrement (ZD)</label>
    <!-- TOUS les r√¥les peuvent changer de ZD -->
    <select id="zd" class="form-select">
      <option value="">-- S√©lectionner --</option>
    </select>
  </div>
</div>

    </div>
  </div>
</div>
</div></div>

<div class="row">
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NB MEN ENUMERES
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="menEnumeresSpan" class="counter-value" data-target="197"><%= stats.menagesEnumeres ?? 0 %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>

				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NB MEN DENOMBRES
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="menDenombresSpan" class="counter-value"><%= stats.menagesDenombres ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<!--
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP CARTO
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="popSpan" class="counter-value">stats.totalPopulation ?? 0</span>
								</h2>
							</div>
						</div>
					</div>
				</div> -->
				<!-- end col -->
				
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TOTAL HOMMES
							<i class=" ri-men-fill text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-men-line  display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="totalHommesSpan" class="counter-value" data-target="32.89"><%= stats.hommes?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TOTAL FEMMES
							<i class="ri-women-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-women-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="totalFemmesSpan" class="counter-value" data-target="1596.5"><%= stats.femmes ?? 0 %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP TOTALE
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popTotaleSpan" class="counter-value" data-target="489.4"><%= stats.total ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP CARTO
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popCartoSpan" class="counter-value" data-target="489.4"><%= stats.cartographie %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">POP RURALE
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="popRuraleSpan" class="counter-value" data-target="489.4"><%= stats.populationRurale ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				
				<!-- end col -->
				
				
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
</div>
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">	
				
				
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TAUX PROGRESSION
							<i class="ri-percent-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-percent-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id= "tauxProgressionSpan" class="counter-value" data-target="2659"><%= stats.tauxProgressionCollecte %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col 
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">DUREE MOYENNE INTERVIEW
							<i class="ri-time-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-time-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span class="counter-value" data-target="1596.5"></span>
								</h2>
							</div>
						</div>
					</div>
				</div>-->
				<div class="col"  style="flex: 0 0 14.28%; max-width: 14.28%;">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">ECART NMC ET NMD
							<i class="ri-group-fill text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-group-fill display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="enmcdPop" class="counter-value" data-target="32.89"><%= stats.enmcd.ecart ?? 0 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">TAILLE MOYENNE MENAGE
							<i class="ri-percent-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-percent-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="tmoyenMenSpan" class="counter-value" data-target="2659"><%= stats.tailleMoyenneMenage %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">RRAVI
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="rraviSpan" class="counter-value" data-target="197"><%= stats.RRAVI %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">RAPPORT DE MASCULINITE
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="rMasculiniteSpan" class="counter-value" data-target="197"><%= stats.rapportMasculinite %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PARITE ATTEINTE 15-49 ANS
							<i class="ri-team-fill text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="pa49Span" class="counter-value" data-target="489.4"><%= stats.PA49 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
</div>
<div class="col-xl-12">
	<div class="card crm-widget">
		<div class="card-body p-0">
			<div class="row row-cols-xxl-6 row-cols-lg-3 row-cols-md-2 row-cols-1 g-0">
				
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MOYEN DECES PAR MENAGE
							<i class="ri-team-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-group-fill display-6  text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<h2 class="mb-0 cfs-22"><span id="decesSpan" class="counter-value"><%= (stats.averageDeces !== undefined && stats.averageDeces !== null) ? Number(stats.averageDeces).toFixed(2) : '‚Äî' %></span>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->


				<!--D√©but Ly -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PROPORTION MENAGES AGRICOLES
							<i class="ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" display-6 text-muted cfs-22">üåæ</i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="agriSpan" class="counter-value"><%= stats.proportionAgricoles %> %</span>
								</h2> %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NMPE
							<i class=" ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span class="counter-value" id="emigreSpan" data-target="197"> <%= stats.averageEmigres %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">PROP ENFANTS 0-5 ANS
							<i class=" ri-emotion-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class=" ri-emotion-fill display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="enfantSpan" class="counter-value" data-target="489.4"> <%= stats.proportionEnfantsMoins5 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-md-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MENAGES +10 INDIVIDUS
							<i class="ri-team-line text-danger fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22">
									<span id="grandMenagesSpan" class="counter-value" data-target="32.89">  <%= stats.nbMenagesPlus10 %></span></h2>
							</div>
						</div>
					</div>
				</div>
				<!-- end col -->
				<div class="col">
					<div class="mt-3 mt-lg-0 py-4 px-3">
						<h5 class="text-muted text-uppercase fs-13">NBRE MENAGES 1 INDIVIDUS
							<i class="ri-team-line text-success fs-18 float-end align-middle"></i>
						</h5>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<i class="ri-team-line display-6 text-muted cfs-22"></i>
							</div>
							<div class="flex-grow-1 ms-3">
								<h2 class="mb-0 cfs-22"><span id="menagesSoloSpan"  class="counter-value" data-target="1596.5"><%= stats.nbMenagesSolo %></span>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- FIN Ly-->
				
        
			</div>
			<!-- end row -->
		</div>
		<!-- end card body -->
	</div>
	<!-- end card -->
  
</div>
<!-- end col --></div><!-- end row -->

<script>

document.addEventListener('DOMContentLoaded', () => {
  const selects = {
    region: document.getElementById('region'),
    departement: document.getElementById('departement'),
    commune: document.getElementById('commune'),
    zd: document.getElementById('zd')
  };

  console.log('üìå √âl√©ments DOM:', selects);

  // ‚úÖ V√©rifie si c'est un select actif
  const isActiveSelect = (element) => {
    return element && element.tagName === 'SELECT';
  };

  // ‚úÖ Gestion am√©lior√©e de la r√©cup√©ration de valeur
  const getSelectValue = (elementId) => {
    const element = document.getElementById(elementId);
    if (!element) return '';
    
    if (element.tagName === 'INPUT' && element.type === 'hidden') {
      return element.value || '';
    }
    
    if (element.tagName === 'SELECT') {
      return element.value || '';
    }
    
    return '';
  };

  const statsSpans = {
    menEnumeresSpan: 'menagesEnumeres',
    menDenombresSpan: 'menagesDenombres',
    totalHommesSpan: 'hommes',
    totalFemmesSpan: 'femmes',
    popTotaleSpan: 'total',
    popCartoSpan: 'cartographie',
    popRuraleSpan: 'populationRurale',
    enmcdPop: 'enmcd.ecart',
    tauxProgressionSpan: 'tauxProgressionCollecte',
    tmoyenMenSpan: 'tailleMoyenneMenage',
    rraviSpan: 'RRAVI',
    rMasculiniteSpan: 'rapportMasculinite',
    pa49Span: 'PA49',
    decesSpan: 'averageDeces',
    agriSpan: 'proportionAgricoles',
    emigreSpan: 'averageEmigres',
    enfantSpan: 'proportionEnfantsMoins5',
    grandMenagesSpan: 'nbMenagesPlus10',
    menagesSoloSpan: 'nbMenagesSolo'
  };

  const optionsCache = {};
  const statsCache = {};

  const showLoader = () => {
    const loader = document.getElementById('globalLoader');
    if (loader) loader.style.display = 'flex';
  };
  
  const hideLoader = () => {
    const loader = document.getElementById('globalLoader');
    if (loader) loader.style.display = 'none';
  };

  function debounce(fn, delay = 200) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  }

  async function loadOptions(url, select, valueField, textField) {
    if (!isActiveSelect(select)) {
      console.log(`‚ùå Select ${select.id} n'est pas actif, skip`);
      return;
    }

    const cacheKey = url;
    if (optionsCache[cacheKey]) {
      console.log(`‚úÖ Utilisation du cache pour ${url}`);
      populateSelect(select, optionsCache[cacheKey], valueField, textField);
      return;
    }

    console.log(`üì• Chargement: ${url}`);
    
    // Sauvegarder l'√©tat actuel
    const currentValue = select.value;
    const currentOptions = Array.from(select.options).map(opt => ({
      value: opt.value,
      text: opt.text,
      selected: opt.selected
    }));

    // Afficher l'√©tat de chargement
    select.innerHTML = '';
    const loadingOption = new Option('Chargement...', '', true, true);
    loadingOption.disabled = true;
    select.appendChild(loadingOption);
    select.disabled = false; // IMPORTANT: Toujours activer pendant le chargement

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      
      console.log(`‚úÖ Donn√©es re√ßues pour ${url}:`, data.length, '√©l√©ments');
      optionsCache[cacheKey] = data;
      
      // Peupler le select
      populateSelect(select, data, valueField, textField);
      
      // Restaurer la valeur pr√©c√©dente si elle existe
      if (currentValue && data.some(item => item[valueField] === currentValue)) {
        select.value = currentValue;
        console.log(`‚úÖ Valeur restaur√©e pour ${select.id}:`, currentValue);
      }
      
      return data;
    } catch (err) {
      console.error('‚ùå Erreur:', err);
      
      // Restaurer les options pr√©c√©dentes en cas d'erreur
      select.innerHTML = '';
      currentOptions.forEach(opt => {
        const option = new Option(opt.text, opt.value, opt.selected, opt.selected);
        select.appendChild(option);
      });
      
      select.disabled = false;
      return [];
    }
  }

  function populateSelect(select, data, valueField, textField) {
    select.innerHTML = '';
    
    // Toujours ajouter l'option vide
    const emptyOption = new Option('-- S√©lectionner --', '');
    select.appendChild(emptyOption);
    
    if (data && data.length > 0) {
      console.log(`üìù Peupler ${select.id} avec ${data.length} options`);
      
      data.forEach(item => {
        const option = new Option(item[textField], item[valueField]);
        select.appendChild(option);
      });
      
      select.disabled = false;
    } else {
      console.warn(`‚ö†Ô∏è Aucune donn√©e pour ${select.id}`);
      select.disabled = false; // Toujours activer m√™me si vide
    }
  }

  async function fetchStats(paramsObj) {
    // Nettoyer les param√®tres vides
    const cleanParams = {};
    Object.entries(paramsObj).forEach(([key, value]) => {
      if (value && value.trim() !== '') {
        cleanParams[key] = value;
      }
    });

    const key = JSON.stringify(cleanParams);
    if (statsCache[key]) {
      console.log('‚úÖ Utilisation du cache stats');
      return statsCache[key];
    }

    const params = new URLSearchParams(cleanParams);
    const url = `/stats?${params}&_cb=${Date.now()}`;
    console.log('üìä Requ√™te stats:', url);
    
    const response = await fetch(url);
    const data = await response.json();
    
    statsCache[key] = data;
    return data;
  }

  async function updateStats() {
    showLoader();
    try {
      const paramsObj = {
        region: getSelectValue('region'),
        departement: getSelectValue('departement'),
        commune: getSelectValue('commune'),
        zd: getSelectValue('zd')
      };

      console.log('üìä PARAMS pour stats:', paramsObj);
      const data = await fetchStats(paramsObj);

      // Mettre √† jour tous les spans
      Object.entries(statsSpans).forEach(([spanId, dataKey]) => {
        const element = document.getElementById(spanId);
        if (!element) return;
        
        let value = data;
        if (dataKey.includes('.')) {
          const keys = dataKey.split('.');
          keys.forEach(key => {
            value = value ? value[key] : undefined;
          });
        } else {
          value = data[dataKey];
        }
        
        // Formater la valeur si n√©cessaire
        if (spanId === 'tauxProgressionSpan' && value !== undefined) {
          element.textContent = value + '%';
        } else if (spanId === 'agriSpan' && value !== undefined) {
          element.textContent = value + '%';
        } else if (spanId === 'enfantSpan' && value !== undefined) {
          element.textContent = value + '%';
        } else if (spanId === 'rMasculiniteSpan' && value !== undefined) {
          element.textContent = value.toFixed(2);
        } else if (spanId === 'pa49Span' && value !== undefined) {
          element.textContent = value.toFixed(2);
        } else if (value !== undefined && value !== null) {
          element.textContent = value;
        } else {
          element.textContent = '‚Äî';
        }
      });
    } catch (err) {
      console.error('‚ùå Erreur dans updateStats:', err);
    } finally {
      hideLoader();
    }
  }

  const debouncedUpdateStats = debounce(updateStats, 200);

  // ‚úÖ √âCOUTEURS CORRIG√âS - Gestion am√©lior√©e des changements
  if (isActiveSelect(selects.region)) {
    selects.region.addEventListener('change', async (e) => {
      console.log('üîò Region chang√©e:', e.target.value);
      
      // R√©initialiser les niveaux inf√©rieurs
      if (isActiveSelect(selects.departement)) {
        selects.departement.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.departement.disabled = false; // IMPORTANT: Toujours activer
      }
      
      if (isActiveSelect(selects.commune)) {
        selects.commune.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.commune.disabled = false;
      }
      
      if (isActiveSelect(selects.zd)) {
        selects.zd.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.zd.disabled = false;
      }

      if (selects.region.value) {
        console.log('üì• Chargement d√©partements pour r√©gion:', selects.region.value);
        await loadOptions(`/api/location/departements?region=${selects.region.value}`, 
                          selects.departement, 'code_departement', 'departement');
      }
      
      debouncedUpdateStats();
    });
  }

  if (isActiveSelect(selects.departement)) {
    selects.departement.addEventListener('change', async (e) => {
      console.log('üîò D√©partement chang√©:', e.target.value);
      
      // R√©initialiser les niveaux inf√©rieurs
      if (isActiveSelect(selects.commune)) {
        selects.commune.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.commune.disabled = false;
      }
      
      if (isActiveSelect(selects.zd)) {
        selects.zd.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.zd.disabled = false;
      }

      if (selects.departement.value) {
        console.log('üì• Chargement communes pour d√©partement:', selects.departement.value);
        await loadOptions(`/api/location/communes?departement=${selects.departement.value}`, 
                          selects.commune, 'code_commune', 'commune');
      }
      
      debouncedUpdateStats();
    });
  }

  if (isActiveSelect(selects.commune)) {
    selects.commune.addEventListener('change', async (e) => {
      console.log('üîò Commune chang√©e:', e.target.value);
      
      // R√©initialiser ZD
      if (isActiveSelect(selects.zd)) {
        selects.zd.innerHTML = '<option value="">-- S√©lectionner --</option>';
        selects.zd.disabled = false;
      }

      if (selects.commune.value) {
        console.log('üì• Chargement ZDs pour commune:', selects.commune.value);
        await loadOptions(`/api/location/zds?commune=${selects.commune.value}`, 
                          selects.zd, 'mo_zd', 'mo_zd');
      }
      
      debouncedUpdateStats();
    });
  }

  if (isActiveSelect(selects.zd)) {
    selects.zd.addEventListener('change', (e) => {
      console.log('üîò ZD chang√©e:', e.target.value);
      debouncedUpdateStats();
    });
  }

  // ‚úÖ INITIALISATION
  const userRole = '<%= user.role %>';
  console.log('üë§ R√¥le:', userRole);
  
  // Fonction pour initialiser Select2
  const initializeSelect2 = () => {
    if (typeof $ !== 'undefined' && $.fn.select2) {
      console.log('üîß Initialisation Select2...');
      
      // Attendre que tout soit charg√©
      setTimeout(() => {
        $('.form-select').each(function() {
          const $select = $(this);
          
          // Ne pas appliquer Select2 sur les selects d√©sactiv√©s ou verrouill√©s
          if (!$select.prop('disabled') && $select.find('option').length > 0) {
            $select.select2({
              placeholder: '-- S√©lectionner --',
              allowClear: true,
              width: '100%',
              theme: 'bootstrap-5',
              dropdownParent: $select.closest('.modal, .row') // Important pour le positionnement
            });
            
            // R√©appliquer les √©v√©nements apr√®s Select2
            const nativeSelect = $select[0];
            if (nativeSelect.id === 'region' || nativeSelect.id === 'departement' || 
                nativeSelect.id === 'commune' || nativeSelect.id === 'zd') {
              
              $select.on('select2:select', function(e) {
                console.log(`üéØ Select2: ${nativeSelect.id} s√©lectionn√©:`, e.params.data.id);
                // D√©clencher l'√©v√©nement change natif
                const event = new Event('change', { bubbles: true });
                nativeSelect.dispatchEvent(event);
              });
              
              $select.on('select2:clear', function() {
                console.log(`üéØ Select2: ${nativeSelect.id} cleared`);
                const event = new Event('change', { bubbles: true });
                nativeSelect.dispatchEvent(event);
              });
            }
          }
        });
        console.log('‚úÖ Select2 initialis√©');
      }, 500);
    } else {
      console.error('‚ùå Select2 non disponible!');
    }
  };

  // Fonction d'initialisation principale
  async function initializeDashboard() {
    const regionCode = getSelectValue('region');
    const deptCode = getSelectValue('departement');
    const communeCode = getSelectValue('commune');
    
    console.log('üîç Codes initiaux - R√©gion:', regionCode, 'D√©partement:', deptCode, 'Commune:', communeCode);
    
    try {
      // Pour ROLE_GLOBAL : Pr√©charger les r√©gions
      if (userRole === 'ROLE_GLOBAL' && isActiveSelect(selects.region)) {
        if (selects.region.options.length <= 1) { // Juste l'option vide
          console.log('üì• Chargement initial des r√©gions pour ROLE_GLOBAL');
          await loadOptions('/api/location/regions', selects.region, 'code_region', 'region');
        }
      }
      
      // Si on a une r√©gion, charger les d√©partements
      if (regionCode && regionCode.trim() !== '' && isActiveSelect(selects.departement)) {
        console.log('üì• Chargement d√©partements pour r√©gion:', regionCode);
        const depts = await loadOptions(`/api/location/departements?region=${regionCode}`, 
                                        selects.departement, 'code_departement', 'departement');
        
        // Si on a un d√©partement dans les donn√©es EJS, le pr√©s√©lectionner
        if (deptCode && deptCode.trim() !== '' && selects.departement) {
          selects.departement.value = deptCode;
          console.log('‚úÖ D√©partement pr√©s√©lectionn√©:', deptCode);
          
          // Si d√©partement s√©lectionn√©, charger les communes
          if (isActiveSelect(selects.commune) && selects.departement.value) {
            console.log('üì• Chargement communes pour d√©partement:', selects.departement.value);
            const communes = await loadOptions(`/api/location/communes?departement=${selects.departement.value}`, 
                                               selects.commune, 'code_commune', 'commune');
            
            // Si on a une commune dans les donn√©es EJS, la pr√©s√©lectionner
            if (communeCode && communeCode.trim() !== '' && selects.commune) {
              selects.commune.value = communeCode;
              console.log('‚úÖ Commune pr√©s√©lectionn√©e:', communeCode);
              
              // Si commune s√©lectionn√©e, charger les ZDs
              if (isActiveSelect(selects.zd) && selects.commune.value) {
                console.log('üì• Chargement ZDs pour commune:', selects.commune.value);
                await loadOptions(`/api/location/zds?commune=${selects.commune.value}`, 
                                  selects.zd, 'mo_zd', 'mo_zd');
              }
            }
          }
        }
      }
      
      // Initialiser les stats
      console.log('üìä Initialisation des stats...');
      await updateStats();
      
      // Initialiser Select2
      initializeSelect2();
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'initialisation:', error);
    }
  }

  // D√©marrer l'initialisation apr√®s un court d√©lai
  setTimeout(() => {
    initializeDashboard();
  }, 100);
});
</script>










